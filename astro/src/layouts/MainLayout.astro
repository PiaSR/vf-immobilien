---
// src/layouts/MainLayout.astro
import Navbar from "../components/Layouts/Navbar.astro";
import Footer from "../components/Layouts/Footer.astro";
import globalStylesUrl from "../styles/global.css?url";
import fontStylesUrl from "../styles/fonts.css?url";
import path from "node:path";
import fs from "node:fs";

// ------------------------------------

const {
  title = "VF Immobilien | Verwaltung, gebaut auf Vertrauen.",
  description = "VF Immobilien | Verwaltung, gebaut auf Vertrauen.",
  ogImage = "/astro/src/assets/images/default-share-image-min.png",
  ogTitle = title,
} = Astro.props;

// --- CRITICAL CSS LOGIC ---
// Define the absolute path to your built critical CSS file
const CRITICAL_CSS_PATH = path.join(
  process.cwd(),
  "src",
  "styles",
  "critical.css" // <-- Points exactly to the source file
);

let criticalCssContent = "";
// Only attempt to read the file during production build
if (import.meta.env.PROD) {
  try {
    // Read the file content synchronously at build time
    criticalCssContent = fs.readFileSync(CRITICAL_CSS_PATH, "utf-8");
  } catch (error) {
    // Log a warning if the file isn't found (e.g., if postbuild script failed)
    console.warn(
      "CRITICAL CSS WARNING: Could not read critical.css.",
      error.message
    );
  }
}
// --- END CRITICAL CSS LOGIC ---
---

<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    {
      criticalCssContent && (
        <style
          id="critical-styles"
          dangerouslySetInnerHTML={{ __html: criticalCssContent }}
        />
      )
    }
    <link
      rel="preload"
      href="/fonts/Inter-SemiBold.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/bitstream-iowan-old-style-black-bt-586c36e930225.ttf"
      as="font"
      type="font/ttf"
      crossorigin
    />
    <link
      rel="preload"
      href={globalStylesUrl}
      as="style"
      onload="this.onload = null; this.rel = 'stylesheet'"
    />
    <noscript><link rel="stylesheet" href={globalStylesUrl} /></noscript>

    <link
      rel="preload"
      href={fontStylesUrl}
      as="style"
      onload="this.onload = null; this.rel = 'stylesheet'"
    />
    <noscript><link rel="stylesheet" href={fontStylesUrl} /></noscript>

    <link href="/logos/Viki-new-logo-only-green-1.svg" as="image" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/logos/Viki-new-logo-only-green-1.svg"
    />

    <title>{title}</title>
    <script
      defer
      id="Cookiebot"
      src="https://consent.cookiebot.com/uc.js"
      data-cbid="dc9e07d5-dc72-477b-ab85-798ff7e1ee18"
      data-blockingmode="auto"
      type="text/javascript"></script>
    <meta name="description" content={description} />

    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={Astro.url.href} />
  </head>

  <body>
    <Navbar />
    <main>
      <slot />
    </main>
    <Footer />

    <script is:inline>
      // Animation Observer Script
      document.addEventListener("DOMContentLoaded", () => {
        const sectionsToAnimate =
          document.querySelectorAll(".slide-in-section");

        const observerOptions = {
          root: null,
          rootMargin: "0px",
          threshold: 0.1,
        };

        const observerCallback = (entries, observer) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        };

        if (sectionsToAnimate.length > 0) {
          const sectionObserver = new IntersectionObserver(
            observerCallback,
            observerOptions
          );

          sectionsToAnimate.forEach((section) => {
            sectionObserver.observe(section);
          });
        }
      });
    </script>
  </body>
</html>
