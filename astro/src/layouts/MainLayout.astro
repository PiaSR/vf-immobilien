---
// src/layouts/MainLayout.astro
import Navbar from "../components/Layouts/Navbar.astro";
import Footer from "../components/Layouts/Footer.astro";
import "../styles/global.css";
import "../styles/fonts.css";

import path from "node:path";
import fs from "node:fs";
// ------------------------------------

const {
  title = "VF Immobilien | Verwaltung, gebaut auf Vertrauen.",
  description = "VF Immobilien | Verwaltung, gebaut auf Vertrauen.",
  ogImage = "/astro/src/assets/images/default-share-image-min.png",
  ogTitle = title,
} = Astro.props;

// --- CRITICAL CSS LOGIC ---
// Define the absolute path to your built critical CSS file
const CRITICAL_CSS_PATH = path.join(
  process.cwd(),
  "dist",
  "client",
  "critical.css"
);

let criticalCssContent = "";
// Only attempt to read the file during production build
if (import.meta.env.PROD) {
  try {
    // Read the file content synchronously at build time
    criticalCssContent = fs.readFileSync(CRITICAL_CSS_PATH, "utf-8");
  } catch (error) {
    // Log a warning if the file isn't found (e.g., if postbuild script failed)
    console.warn(
      "CRITICAL CSS WARNING: Could not read critical.css.",
      error.message
    );
  }
}
// --- END CRITICAL CSS LOGIC ---
---

<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    {
      criticalCssContent && (
        <style
          id="critical-styles"
          dangerouslySetInnerHTML={{ __html: criticalCssContent }}
        />
      )
    }

    <script is:inline>
      function deferStylesheets() {
        // Find all injected Astro CSS links
        document.querySelectorAll('link[rel="stylesheet"]').forEach((link) => {
          if (
            link.href &&
            link.href.includes("/_astro/") &&
            link.media !== "print"
          ) {
            // Force the browser to load it without blocking render
            link.media = "print";
            // Once loaded, apply the styles
            link.onload = function () {
              this.media = "all";
              this.onload = null;
            };
          }
        });
      }

      // Run this script as early as possible
      document.addEventListener("DOMContentLoaded", deferStylesheets);
    </script>

    <noscript> </noscript>
    <link
      rel="preload"
      href="/logos/Viki-new-logo-only-green-1.svg"
      as="image"
    />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/logos/Viki-new-logo-only-green-1.svg"
    />

    <title>{title}</title>
    <script
      defer
      id="Cookiebot"
      src="https://consent.cookiebot.com/uc.js"
      data-cbid="dc9e07d5-dc72-477b-ab85-798ff7e1ee18"
      data-blockingmode="auto"
      type="text/javascript"></script>
    <meta name="description" content={description} />

    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={Astro.url.href} />
  </head>

  <body>
    <Navbar />
    <main>
      <slot />
    </main>
    <Footer />

    <script is:inline>
      // Animation Observer Script
      document.addEventListener("DOMContentLoaded", () => {
        const sectionsToAnimate =
          document.querySelectorAll(".slide-in-section");

        const observerOptions = {
          root: null,
          rootMargin: "0px",
          threshold: 0.1,
        };

        const observerCallback = (entries, observer) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        };

        if (sectionsToAnimate.length > 0) {
          const sectionObserver = new IntersectionObserver(
            observerCallback,
            observerOptions
          );

          sectionsToAnimate.forEach((section) => {
            sectionObserver.observe(section);
          });
        }
      });
    </script>
  </body>
</html>
