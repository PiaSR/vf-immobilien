---
import { Image } from "astro:assets";
import { sanityClient } from "../../../lib/sanityClient";
import SearchIcon from "/src/assets/images/search_24dp_FFF_FILL0_wght400_GRAD0_opsz24.svg";

// --- 1. Define Vienna Districts (Hardcoded for reliability) ---
const viennaDistricts = [
  "1. Innere Stadt",
  "2. Leopoldstadt",
  "3. Landstraße",
  "4. Wieden",
  "5. Margareten",
  "6. Mariahilf",
  "7. Neubau",
  "8. Josefstadt",
  "9. Alsergrund",
  "10. Favoriten",
  "11. Simmering",
  "12. Meidling",
  "13. Hietzing",
  "14. Penzing",
  "15. Rudolfsheim-Fünfhaus",
  "16. Ottakring",
  "17. Hernals",
  "18. Währing",
  "19. Döbling",
  "20. Brigittenau",
  "21. Floridsdorf",
  "22. Donaustadt",
  "23. Liesing",
];

// --- 2. Fetch Dynamic Filter Options from Sanity (Objektart, Amenities) ---
const filterOptionsQuery = `{
    // Fetch property type options (still reliable if a property exists)
    "propertyTypes": *[_type == "propertyType"].title,
    "amenities": *[_type == "ausstattung"].title,
    "surroundingDistrictsRaw": *[_type == "property"].locationSurrounding
}`;

// Fetch the data
let filterData = {
  propertyType: [],
  amenities: [],
  surroundingDistrictsRaw: [],
};
try {
  // NOTE: Corrected object key access from 'propertyType' to 'propertyTypes'
  filterData = await sanityClient.fetch(filterOptionsQuery);
} catch (e) {
  console.error("Failed to fetch filter options from Sanity:", e);
}

const objektarten: string[] = filterData.propertyType || [
  "Wohnung",
  "Haus",
  "Grundstueck",
  "Parkplatz",
  "Gewerbeimmobilie",
];
const amenities: string[] = filterData.amenities || [];
const rawSurrounding: (string | null)[] =
  filterData.surroundingDistrictsRaw || [];
const surroundingDistricts: string[] = Array.from(
  new Set(
    // Filter out null/undefined values (loc is string => !!loc), then create a unique Set
    rawSurrounding.filter((loc): loc is string => !!loc)
  )
);

// Combine the two lists for the Ort panel
const districts = {
  Wien: viennaDistricts, // Now using the hardcoded list
  Niederösterreich: surroundingDistricts,
};

// --- Helper to capitalize first letter ---
const capitalize = (s: string) =>
  s.charAt(0).toUpperCase() + s.slice(1).replace(/-/g, " ");

// Pass districts list to script for client-side use
const allLocations = [...viennaDistricts, ...surroundingDistricts];
---

<section id="properties-filter" class="section-properties-filter-form">
  <div class="properties-filter-wrapper">
    <div id="property-filter-form" class="form-block">
      <form
        id="property-filter-form-element"
        name="property-filter-form"
        class="form"
      >
        <!-- The data-tab attributes are used to find the corresponding panel -->
        <div class="filter-heading-wrapper">
          <div
            data-tab="immobilie"
            class="filter-heading-tab tab-container active"
          >
            <div class="filter-heading-tab-name">Immobilie</div>
            <div id="selection-immobilie" class="filter-heading-tab-selection">
              Alle Kategorien
            </div>
          </div>

          <div data-tab="ort" class="filter-heading-tab tab-container">
            <div class="filter-heading-tab-name">Ort</div>
            <div id="selection-ort" class="filter-heading-tab-selection">
              Alle Orte
            </div>
          </div>

          <div data-tab="groesse" class="filter-heading-tab tab-container">
            <div class="filter-heading-tab-name">Größe</div>
            <div id="selection-groesse" class="filter-heading-tab-selection">
              Jede Größe
            </div>
          </div>

          <div data-tab="preis" class="filter-heading-tab tab-container">
            <div class="filter-heading-tab-name">Preis</div>
            <div id="selection-preis" class="filter-heading-tab-selection">
              Jeder Preis
            </div>
          </div>

          <div data-tab="ausstattung" class="filter-heading-tab tab-container">
            <div class="filter-heading-tab-name">Ausstattung</div>
            <div
              id="selection-ausstattung"
              class="filter-heading-tab-selection"
            >
              Details
            </div>
          </div>
        </div>
      </form>

      <!-- The original search button wrapper is REMOVED from here and placed in the last panel -->
      <div id="filter-panel-wrapper" class="filter-panel-wrapper">
        <div id="panel-immobilie" class="filter-panel panel-immobilie">
          <div id="filter-vermarktungsart" class="filter-form-group">
            <h2 class="filter-form-heading heading-style-h6">
              Vermarktungsart
            </h2>
            <div class="filter-form-input-wrapper radio-input-group">
              <label class="radio-classic-label">
                <input type="radio" name="vermarktungsart" value="miete" />Miete
              </label>
              <label class="radio-classic-label">
                <input type="radio" name="vermarktungsart" value="kauf" />Kauf
              </label>
            </div>
          </div>

          <div id="filter-objektart" class="filter-form-group">
            <h2 class="filter-form-heading heading-style-h6">Objektart</h2>
            {
              objektarten.length > 0 ? (
                <div class="filter-form-input-wrapper checkbox-columns objektart-filter">
                  {objektarten.map((type) => (
                    <label class="checkbox-label">
                      <input
                        type="checkbox"
                        name="objektart"
                        value={type}
                        class="checkbox-input"
                      />
                      <span class="checkbox-text">{type}</span>
                    </label>
                  ))}
                </div>
              ) : (
                <p>Keine Objektarten verfügbar.</p>
              )
            }
          </div>
          <div class="panel-footer">
            <a href="#" data-panel="immobilie" class="reset-button button"
              >Zurücksetzen</a
            >
            <button type="button" class="next-button" data-action="next"
              >Weiter</button
            >
          </div>
        </div>

        <div id="panel-ort" class="filter-panel panel-ort">
          {
            Object.keys(districts).map((region) => (
              <div class="filter-form-group">
                <h2 class="filter-form-heading heading-style-h6">{region}</h2>
                <div class="filter-form-input-wrapper checkbox-columns">
                  <div class="checkbox-column">
                    {districts[region]
                      .slice(0, Math.ceil(districts[region].length / 2))
                      .map((district) => (
                        <label class="checkbox-label">
                          <input
                            type="checkbox"
                            name="lage"
                            value={district}
                            class="checkbox-input"
                          />
                          <span class="checkbox-text">{district}</span>
                        </label>
                      ))}
                  </div>
                  <div class="checkbox-column">
                    {districts[region]
                      .slice(Math.ceil(districts[region].length / 2))
                      .map((district) => (
                        <label class="checkbox-label">
                          <input
                            type="checkbox"
                            name="lage"
                            value={district}
                            class="checkbox-input"
                          />
                          <span class="checkbox-text">{district}</span>
                        </label>
                      ))}
                  </div>
                </div>
              </div>
            ))
          }
          <div class="panel-footer">
            <a href="#" data-panel="immobilie" class="reset-button button"
              >Zurücksetzen</a
            >
            <button type="button" class="next-button" data-action="next"
              >Weiter</button
            >
          </div>
        </div>

        <div id="panel-groesse" class="filter-panel panel-groesse">
          <div class="filter-form-group">
            <h2 class="filter-form-heading heading-style-h6">Zimmer</h2>
            <div class="number-input-wrapper">
              <input
                class="text-field"
                name="zimmer-min"
                placeholder="Min"
                type="number"
                id="filter-zimmer-min"
              />
              <div class="input-separator">bis</div>
              <input
                class="text-field"
                name="zimmer-max"
                placeholder="Max"
                type="number"
                id="filter-zimmer-max"
              />
            </div>
          </div>
          <div class="filter-form-group">
            <h2 class="filter-form-heading heading-style-h6">Fläche (m²)</h2>
            <div class="number-input-wrapper">
              <input
                class="text-field"
                name="flaeche-min"
                placeholder="Min"
                type="number"
                id="filter-flaeche-min"
              />
              <div class="input-separator">bis</div>
              <input
                class="text-field"
                name="flaeche-max"
                placeholder="Max"
                type="number"
                id="filter-flaeche-max"
              />
            </div>
          </div>
          <div class="panel-footer">
            <a href="#" data-panel="immobilie" class="reset-button button"
              >Zurück</a
            >
            <button type="button" class="next-button" data-action="next"
              >Weiter</button
            >
          </div>
        </div>

        <div id="panel-preis" class="filter-panel panel-preis">
          <div class="filter-form-group price-group price-group-kauf">
            <h2 class="filter-form-heading heading-style-h6">Kaufpreis (€)</h2>
            <div class="number-input-wrapper">
              <input
                class="text-field"
                name="preis-kauf-min"
                placeholder="Min"
                type="number"
                id="filter-preis-kauf-min"
              />
              <div class="input-separator">bis</div>
              <input
                class="text-field"
                name="preis-kauf-max"
                placeholder="Max"
                type="number"
                id="filter-preis-kauf-max"
              />
            </div>
          </div>

          <div class="filter-form-group price-group price-group-miete">
            <h2 class="filter-form-heading heading-style-h6">Miete (€)</h2>
            <div class="number-input-wrapper">
              <input
                class="text-field"
                name="preis-miete-min"
                placeholder="Min"
                type="number"
                id="filter-preis-miete-min"
              />
              <div class="input-separator">bis</div>
              <input
                class="text-field"
                name="preis-miete-max"
                placeholder="Max"
                type="number"
                id="filter-preis-miete-max"
              />
            </div>
          </div>

          <div class="panel-footer">
            <a href="#" data-panel="immobilie" class="reset-button button"
              >Zurück</a
            >
            <button type="button" class="next-button" data-action="next"
              >Weiter</button
            >
          </div>
        </div>
        <div id="panel-ausstattung" class="filter-panel panel-ausstattung">
          <div class="filter-form-group">
            <h2 class="filter-form-heading heading-style-h6">Details</h2>
            <div class="filter-form-input-wrapper checkbox-columns">
              <div class="checkbox-column">
                {
                  amenities
                    .slice(0, Math.ceil(amenities.length / 2))
                    .map((amenity) => (
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          name="ausstattung"
                          value={amenity}
                          class="checkbox-input"
                        />
                        <span class="checkbox-text">{capitalize(amenity)}</span>
                      </label>
                    ))
                }
              </div>
              <div class="checkbox-column">
                {
                  amenities
                    .slice(Math.ceil(amenities.length / 2))
                    .map((amenity) => (
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          name="ausstattung"
                          value={amenity}
                          class="checkbox-input"
                        />
                        <span class="checkbox-text">{capitalize(amenity)}</span>
                      </label>
                    ))
                }
              </div>
            </div>
          </div>
          <div class="panel-footer">
            <a href="#" data-panel="immobilie" class="reset-button button"
              >Zurück</a
            >
            <button type="button" class="next-button" data-action="next"
              >Weiter</button
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<style>
  /* ==============================================================
  BASE STRUCTURE & LAYOUT
  ============================================================== */

  .section-properties-filter-form {
    padding: var(--spacing-xl) 0;
    background-color: var(--color-brand-light-green);
  }

  .properties-filter-wrapper {
    /* Note: width: 50rem is too narrow for max-width: 1200px - corrected to a max-width based approach */
    /* width: 90%; */
    /* max-width: 1200px; */
    margin: 0 auto;
    /* height: 100%; */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: var(--spacing-xl);
    background-color: var(--color-neutral-lightest);
    border-radius: var(--border-radius);
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    position: relative;
  }

  /* ==============================================================
FILTER HEADER (TABS) - DESKTOP DEFAULT
============================================================== */

  .filter-heading-wrapper {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--spacing-sm);
    background-color: var(--color-neutral-lightest);
    padding: var(--spacing-sm);
    border-radius: var(--border-radius);
  }

  .filter-heading-tab {
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-sm);
    transition:
      background-color 0.2s,
      box-shadow 0.2s;
  }

  .filter-heading-tab:hover {
    background-color: var(--color-neutral-light);
  }

  /* Active state for tab logic (requires JavaScript) */
  .filter-heading-tab.active {
    box-shadow: inset 0 0 0 2px var(--color-brand-dark-green);
    background-color: var(--color-neutral-light);
  }

  .filter-heading-tab-name {
    font-size: var(--font-size-caption);
    color: var(--color-neutral-medium);
  }

  .filter-heading-tab-selection {
    font-size: var(--font-size-body-small);
    font-weight: var(--font-weight-bold);
    color: var(--color-neutral-dark);
    /* Ensure selection text doesn't overflow */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  /* ==============================================================
SEARCH BUTTON
============================================================== */

  /* CONSOLIDATED: Combined margin:0 from late block */
  .search-button-wrapper {
    grid-column: 6 / 7;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    margin: 0; /* Merged */
  }

  .custom-submit-button {
    background-color: var(--color-brand-dark-green);
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    font-size: var(--font-size-body);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    height: 100%;
    transition: background-color 0.2s;
  }

  .custom-submit-button:hover {
    background-color: #047857; /* Placeholder color kept */
  }

  .search-icon {
    width: 1.5em;
    height: 1.5em;
  }

  /* ==============================================================
FILTER PANELS (The drop-downs) - DESKTOP DEFAULT
============================================================== */

  /* CONSOLIDATED: Merged properties from the two separate .filter-panel-wrapper definitions */
  .filter-panel-wrapper {
    position: relative;

    padding-top: 10px; /* WIN: Used the later, explicit padding */

    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 10;
  }

  /* CONSOLIDATED: Merged properties from the two separate .filter-panel definitions */
  .filter-panel {
    display: flex; /* Default state for desktop dropdowns (JS handles opacity/visibility) */
    flex-direction: column;
    position: absolute; /* Panels are absolute relative to the FORM */
    top: 0; /* Ensure panels start at the top of the wrapper */
    left: 0; /* JS will override this for specific tab positioning */

    border-radius: var(--border-radius);
    padding: var(--spacing-xl); /* WIN: Used variable-based padding */
    box-sizing: border-box; /* ADDED: Ensures padding doesn't increase size */

    z-index: 1;

    /* Hiding mechanism for desktop (JS toggles .active class) */
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  /* CONSOLIDATED: Merged the two active definitions */
  .filter-panel.active {
    display: flex; /* Keep flex display when active */
    opacity: 1;
    pointer-events: auto;
  }

  .filter-form-group {
    margin-bottom: var(--spacing-lg);
  }

  .filter-form-heading {
    font-size: var(--font-size-h6);
    margin-bottom: var(--spacing-md);
    color: var(--color-neutral-dark);
  }

  /* ==============================================================
INPUT STYLES: RADIO/CHECKBOX
============================================================== */

  .radio-input-group {
    display: flex;
    gap: var(--spacing-xl);
  }

  .radio-classic-label,
  .checkbox-label {
    cursor: pointer;
    user-select: none;
    font-size: var(--font-size-body-small);
    color: var(--color-neutral-font-dark);
  }

  .radio-classic-label {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) 0;
  }

  .radio-classic-label input[type="radio"] {
    margin: 0;
  }

  /* Checkbox Grid Layout */
  .checkbox-columns {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-lg) var(--spacing-2xl);
  }

  .checkbox-column {
    flex: 1;
    min-width: 180px;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  /* Hide native checkbox input */
  .checkbox-input {
    margin: 0;
  }

  /* ==============================================================
INPUT STYLES: NUMBER/TEXT FIELDS
============================================================== */

  .number-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    max-width: 300px;
  }

  .text-field {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-neutral-medium);
    border-radius: var(--border-radius-sm);
    width: 100px;
    flex-grow: 1;
    font-size: var(--font-size-body-small);
  }

  .input-separator {
    color: var(--color-neutral-medium);
    font-size: var(--font-size-body-small);
  }

  .price-group.hidden {
    display: none !important;
  }

  /* ==============================================================
UTILITY & FOOTER
============================================================== */

  .reset-button {
    margin-top: var(--spacing-md);
    display: inline-block;
    color: var(--color-brand-dark-green);
    text-decoration: underline;
    cursor: pointer;
    font-size: var(--font-size-body-small);
  }

  /* Panel Footer (New styles combined) */
  .panel-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
    flex-shrink: 0;
  }

  .next-button {
    display: inline-flex;
    padding: 12px 24px;
    background-color: #0056b3;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    transition: background-color 0.2s;
    text-decoration: none;
    align-items: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .next-button:hover {
    background-color: #003d7a;
  }

  #search-button {
    /* Removed: This was likely a leftover conflict. Desktop search is handled by the wrapper's visibility. */
    /* The media queries handle the visibility of the wrapper correctly. */
  }

  /* ==============================================================
MOBILE STACKED ACCORDION LAYOUT (max-width: 991px)
============================================================== */

  @media (max-width: 991px) {
    .properties-filter-wrapper {
      padding: 0;
    }

    .form {
      gap: 0;
      width: 90%;
      position: static; /* Reset desktop relative position for form */
      margin: 0 auto;
    }

    /* 1. Header (filter-heading-bar) becomes vertical accordion headers */
    .filter-heading-bar {
      display: flex; /* Override grid */
      flex-direction: column;
      gap: 0;
      padding: 0;
      background-color: transparent;
      box-shadow: none;
    }

    /* 2. Individual Tabs (The accordion headers) */
    .filter-heading-tab {
      border-radius: 0;
      padding: var(--spacing-md) var(--spacing-lg);
      background-color: var(--color-neutral-lightest);
      border: 1px solid var(--color-neutral-light);
      margin-top: -1px; /* Collapse borders */
    }

    /* Top and bottom rounding */
    .filter-heading-tab:first-child {
      margin-top: 0;
      border-top-left-radius: var(--border-radius);
      border-top-right-radius: var(--border-radius);
    }
    .filter-heading-tab:last-of-type {
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
    }

    /* Active tab styling: remove bottom border so panel border aligns */
    .filter-heading-tab.active {
      box-shadow: none;
      border-bottom: none;
      /* Re-apply top border radius if this is the first item */
    }

    /* Hide the selection text on mobile to simplify header */
    .filter-heading-tab-selection {
      display: none;
    }

    /* 3. Search Button (Full width at the bottom) */
    /* Remove search button from the accordion list flow */
    .filter-heading-bar .search-button-wrapper {
      display: none;
    }

    /* Place the search button visually below the accordion structure */
    #property-filter-form-element > .search-button-wrapper {
      display: block;
      padding: var(--spacing-md);
    }

    .search-button-wrapper .custom-submit-button {
      width: 100%;
      height: auto;
    }

    /* 4. Panel Wrapper (Static for inline flow) */
    .filter-panel-wrapper {
      position: relative;
      min-height: auto;
      padding-top: 0;
    }

    /* 5. Panels (Accordion content) */
    .filter-panel {
      /* Remove absolute positioning for stacking */
      position: absolute; /* CRITICAL: Reset desktop absolute position */
      top: auto;
      left: auto;
      right: auto;
      width: 100%; /* Full width on mobile */

      border: 1px solid var(--color-neutral-light);
      border-top: none;
      border-radius: 0;
      margin-top: -1px; /* Connect to header above */
      margin-bottom: var(--spacing-md); /* Space below panel */

      padding: var(--spacing-xl);
      z-index: 1;

      /* Initial state: Hide all panels, use display for toggling */
      opacity: 1; /* Reset opacity from desktop hiding mechanism */
      pointer-events: auto; /* Reset pointer-events */
      transition: none;
      display: none;
    }

    /* Active panel state: Show inline */
    .filter-panel.active {
      display: block;
      /* If it's the last panel, give it a rounded bottom */
      border-bottom-left-radius: var(--border-radius);
      border-bottom-right-radius: var(--border-radius);
    }

    /* Reset columns for mobile checkbox layouts */
    .checkbox-columns {
      flex-direction: column;
      gap: var(--spacing-sm);
    }
    .checkbox-column {
      min-width: 100%;
    }
  }

  /* ==============================================================
DESKTOP RE-APPLICATION (min-width: 992px)
============================================================== */
  @media (min-width: 992px) {
    .properties-filter-wrapper {
      width: 50rem; /* Re-apply specific desktop width */
      padding: var(--spacing-xl); /* Re-apply specific desktop padding */
    }

    .filter-panel-wrapper {
      position: relative; /* Ensure it stays relative for desktop absolute children */
      /* Reset mobile margin-bottom and padding-top */
      margin-bottom: 0;
      padding-top: 10px;
    }

    .filter-panel {
      position: absolute; /* Re-apply absolute position for overlapping desktop panels */
      display: flex; /* Re-apply flex display for internal content structure */
      width: 100%; /* Specific width for the dropdown panel */

      /* Reset mobile styles */
      margin-bottom: 0;
      border-radius: var(--border-radius);
      border: none;
      margin-top: 0;

      /* Re-enable desktop hiding mechanism */
      opacity: 0;
      pointer-events: none;
    }

    .filter-panel.active {
      opacity: 1;
      pointer-events: auto;
      display: flex; /* Ensure it overrides the mobile display: block/none toggle */
    }

    /* Ensure only desktop search button is used */
    #property-filter-form-element > .search-button-wrapper {
      display: none;
    }
    .filter-heading-bar .search-button-wrapper {
      display: flex;
    }
  }
</style>
<script define:vars={{ allLocations, viennaDistricts }}>
document.addEventListener("DOMContentLoaded", () => {
  // Re-declare local variables for the script context
  const formElement = document.getElementById("property-filter-form-element");
  const panelTabs = document.querySelectorAll(".filter-heading-tab");
  const panels = document.querySelectorAll(".filter-panel");
  const nextButtons = document.querySelectorAll(
    '.next-button[data-action="next"]'
  );

  // Get references to selection text elements
  const selectionImmobilie = document.getElementById("selection-immobilie");
  const selectionOrt = document.getElementById("selection-ort");
  const selectionGroesse = document.getElementById("selection-groesse");
  const selectionPreis = document.getElementById("selection-preis");
  const selectionAusstattung = document.getElementById(
    "selection-ausstattung"
  );
  const priceGroupKauf = document.querySelector(".price-group-kauf");
  const priceGroupMiete = document.querySelector(".price-group-miete");

  // Array of panel IDs and their associated tab names for sequential navigation
  const panelSequence = [
    "immobilie",
    "ort",
    "groesse",
    "preis",
    "ausstattung",
  ];

  let currentPanelIndex = 0;

  function adjustWrapperHeight(activePanel) {
    const wrapper = document.querySelector(".filter-panel-wrapper");
    // Check if we are in the mobile layout (panels are position: static)
    // If panels are static, we don't need to force a height.
    if (window.getComputedStyle(activePanel).position === "static") {
      wrapper.style.minHeight = "auto";
      return;
    }

    // Get the actual height of the currently active panel (offsetHeight includes padding/border)
    const activeHeight = activePanel.offsetHeight;

    // Apply this height to the wrapper, adding a small buffer for safety
    const buffer = 24;
    wrapper.style.minHeight = `${activeHeight + buffer}px`;
  }

  // --- Utility Function: Get Value or Null (preserved) ---
  const getInputValue = (name) => {
    const input = formElement.querySelector(`[name="${name}"]`);
    return input?.value ? input.value : null;
  };

  // --- Utility Function: Format Price (preserved) ---
  const formatPrice = (price) => {
    if (price === null || isNaN(Number(price))) return "";
    return new Intl.NumberFormat("de-DE", {
      maximumFractionDigits: 0,
    }).format(Number(price));
  };

  // --- CORE LOGIC: UPDATE TAB SELECTION TEXTS (preserved) ---
  const updateTabSelections = () => {
    const formData = new FormData(formElement);

    // --- 1. IMMOBILIE (vermarktungsart, objektart) ---
    const vmArt = formData.get("vermarktungsart");
    const objArts = formData.getAll("objektart").filter((v) => v.length > 0);

    let immobilietext = "Alle Kategorien";
    const vmAction = vmArt === "miete" ? "mieten" : "kaufen";
    const vmType = vmArt === "miete" ? "Mieten" : "Kaufen";

    if (vmArt && objArts.length === 0) {
      immobilietext = vmType;
    } else if (vmArt && objArts.length === 1) {
      immobilietext = `${objArts[0]} ${vmAction}`;
    } else if (vmArt && objArts.length > 1) {
      immobilietext = `${objArts.length} Objektarten ${vmAction}`;
    } else if (!vmArt && objArts.length === 1) {
      immobilietext = objArts[0];
    } else if (!vmArt && objArts.length > 1) {
      immobilietext = `${objArts.length} Objektarten`;
    }
    selectionImmobilie.textContent = immobilietext;

    // --- 2. ORT (lage) ---
    const selectedLages = formData.getAll("lage").filter((v) => v.length > 0);
    let ortText = "Alle Orte";
    if (selectedLages.length === 1) {
      ortText = selectedLages[0];
    } else if (selectedLages.length > 1) {
      ortText = `${selectedLages.length} Orte`;
    }
    selectionOrt.textContent = ortText;

    // --- 3. GRÖSSE (zimmer, flaeche) ---
    let zimmerMin = getInputValue("zimmer-min");
    let zimmerMax = getInputValue("zimmer-max");
    let flaecheMin = getInputValue("flaeche-min");
    let flaecheMax = getInputValue("flaeche-max");

    let zimmerText = "";
    if (zimmerMin && zimmerMax) {
      zimmerText = `${zimmerMin} - ${zimmerMax} Zimmer`;
    } else if (zimmerMin) {
      zimmerText = `ab ${zimmerMin} Zimmer`;
    } else if (zimmerMax) {
      zimmerText = `bis ${zimmerMax} Zimmer`;
    }

    let flaecheText = "";
    if (flaecheMin && flaecheMax) {
      flaecheText = `${flaecheMin} - ${flaecheMax} m²`;
    } else if (flaecheMin) {
      flaecheText = `ab ${flaecheMin} m²`;
    } else if (flaecheMax) {
      flaecheText = `bis ${flaecheMax} m²`;
    }

    let groesseText = "Jede Größe";
    if (zimmerText && flaecheText) {
      groesseText = `${zimmerText}, ${flaecheText}`;
    } else if (zimmerText) {
      groesseText = zimmerText;
    } else if (flaecheText) {
      groesseText = flaecheText;
    }
    selectionGroesse.textContent = groesseText;

    // --- 4. PREIS (price-kauf/miete) ---
    let kaufMin = getInputValue("preis-kauf-min");
    let kaufMax = getInputValue("preis-kauf-max");
    let mieteMin = getInputValue("preis-miete-min");
    let mieteMax = getInputValue("preis-miete-max");

    let kaufRange = "";
    let mieteRange = "";

    if (kaufMin || kaufMax) {
      if (kaufMin && kaufMax) {
        kaufRange = `${formatPrice(kaufMin)} - ${formatPrice(kaufMax)} €`;
      } else if (kaufMin) {
        kaufRange = `ab ${formatPrice(kaufMin)} €`;
      } else if (kaufMax) {
        kaufRange = `bis ${formatPrice(kaufMax)} €`;
      }
    }

    if (mieteMin || mieteMax) {
      if (mieteMin && mieteMax) {
        mieteRange = `${formatPrice(mieteMin)} - ${formatPrice(mieteMax)} €/Monat`;
      } else if (mieteMin) {
        mieteRange = `ab ${formatPrice(mieteMin)} €/Monat`;
      } else if (mieteMax) {
        mieteRange = `bis ${formatPrice(mieteMax)} €/Monat`;
      }
    }

    let preisText = "Jeder Preis";
    if (vmArt === "kauf") {
      preisText = kaufRange || "Jeder Preis";
    } else if (vmArt === "miete") {
      preisText = mieteRange.replace("/Monat", "") || "Jeder Preis";
    } else {
      if (kaufRange && mieteRange) {
        preisText = "Kauf & Miete";
      } else if (kaufRange) {
        preisText = kaufRange;
      } else if (mieteRange) {
        preisText = mieteRange.replace("/Monat", "");
      }
    }
    selectionPreis.textContent = preisText;

    // --- 5. AUSSTATTUNG (ausstattung) ---
    const selectedAmenities = formData
      .getAll("ausstattung")
      .filter((v) => v.length > 0);
    let ausstattungText = "Details";

    if (selectedAmenities.length === 1) {
      ausstattungText = capitalize(selectedAmenities[0]);
    } else if (selectedAmenities.length > 1) {
      ausstattungText = `${selectedAmenities.length} Details`;
    }
    selectionAusstattung.textContent = ausstattungText;
  };

  // --- Price Group Visibility Logic (preserved) ---
  function handleVermarktungsartChange() {
    const vmArt = getInputValue("vermarktungsart");

    // Hide both first
    priceGroupKauf.classList.add("hidden");
    priceGroupMiete.classList.add("hidden");

    if (vmArt === "miete") {
      priceGroupMiete.classList.remove("hidden");
    } else if (vmArt === "kauf") {
      priceGroupKauf.classList.remove("hidden");
    } else {
      // Show both if nothing is selected (default)
      priceGroupKauf.classList.remove("hidden");
      priceGroupMiete.classList.remove("hidden");
    }
  }

  // --- NEW WIZARD NAVIGATION LOGIC ---

  /**
   * Hides all panels/tabs and shows the panel/tab for the given index.
   * @param {number} index The index of the panel to show (0 to 4).
   */
  function showPanel(index) {
    if (index < 0 || index >= panelSequence.length) return;

    currentPanelIndex = index;

    // Hide all panels and remove active class from all tabs
    panels.forEach((p) => p.classList.remove("active"));
    panelTabs.forEach((t) => t.classList.remove("active"));

    // Get the ID of the panel to show
    const panelName = panelSequence[currentPanelIndex];
    const panelElement = document.getElementById(`panel-${panelName}`);
    const tabElement = document.querySelector(
      `.filter-heading-tab[data-tab="${panelName}"]`
    );

    // Show the current panel and set the corresponding tab as active
    if (panelElement) {
      panelElement.classList.add("active");

      adjustWrapperHeight(panelElement);
    }
    if (tabElement) tabElement.classList.add("active");

    // Ensure price groups are correct when navigating to the price panel
    if (panelName === "preis" || panelName === "immobilie") {
      handleVermarktungsartChange();
    }
  }

  // --- CORE LOGIC: SETUP EVENT LISTENERS ---
  const setupEventListeners = () => {
    // 1. Listen for panel input changes to update header texts
    formElement.addEventListener("input", updateTabSelections);

    // 2. Listen for 'Vermarktungsart' change to update price groups
    document.querySelectorAll('[name="vermarktungsart"]').forEach((input) => {
      input.addEventListener("change", () => {
        handleVermarktungsartChange();
        updateTabSelections();
      });
    });

    // 3. Listen for 'Weiter' button clicks
    nextButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const nextIndex = currentPanelIndex + 1;
        showPanel(nextIndex);
      });
    });

    // 4. Tab clicks act as direct navigation to steps
    panelTabs.forEach((tab, index) => {
      tab.addEventListener("click", () => {
        showPanel(index);
      });
    });

    // 5. Run initial state setup
    handleVermarktungsartChange();
  };

  setupEventListeners();
  updateTabSelections(); // Initial text update
  showPanel(0); // Show the first panel on load
});
</script>
