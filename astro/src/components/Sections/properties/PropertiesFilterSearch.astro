---
import { Image } from "astro:assets";
import { sanityClient } from "../../../lib/sanityClient";
import SearchIcon from "/src/assets/images/search_24dp_FFF_FILL0_wght400_GRAD0_opsz24.svg";

// --- 1. Define Vienna Districts (Hardcoded for reliability) ---
const viennaDistricts = [
  "1. Innere Stadt",
  "2. Leopoldstadt",
  "3. Landstraße",
  "4. Wieden",
  "5. Margareten",
  "6. Mariahilf",
  "7. Neubau",
  "8. Josefstadt",
  "9. Alsergrund",
  "10. Favoriten",
  "11. Simmering",
  "12. Meidling",
  "13. Hietzing",
  "14. Penzing",
  "15. Rudolfsheim-Fünfhaus",
  "16. Ottakring",
  "17. Hernals",
  "18. Währing",
  "19. Döbling",
  "20. Brigittenau",
  "21. Floridsdorf",
  "22. Donaustadt",
  "23. Liesing",
];

// --- 2. Fetch Dynamic Filter Options from Sanity (Objektart, Amenities) ---
const filterOptionsQuery = `{
    // Fetch property type options (still reliable if a property exists)
    "propertyTypes": *[_type == "propertyType"].title,
    "amenities": *[_type == "ausstattung"].title,
    "surroundingDistrictsRaw": *[_type == "property"].locationSurrounding
}`;

// Fetch the data
let filterData = {
  propertyType: [],
  amenities: [],
  surroundingDistrictsRaw: [],
};
try {
  // NOTE: Corrected object key access from 'propertyType' to 'propertyTypes'
  filterData = await sanityClient.fetch(filterOptionsQuery);
} catch (e) {
  console.error("Failed to fetch filter options from Sanity:", e);
}

const objektarten: string[] = filterData.propertyType || [
  "Wohnung",
  "Haus",
  "Grundstueck",
  "Parkplatz",
  "Gewerbeimmobilie",
];
const amenities: string[] = filterData.amenities || [];
const rawSurrounding: (string | null)[] =
  filterData.surroundingDistrictsRaw || [];
const surroundingDistricts: string[] = Array.from(
  new Set(
    // Filter out null/undefined values (loc is string => !!loc), then create a unique Set
    rawSurrounding.filter((loc): loc is string => !!loc)
  )
);

// Combine the two lists for the Ort panel
const districts = {
  Wien: viennaDistricts, // Now using the hardcoded list
  Niederösterreich: surroundingDistricts,
};

// --- Helper to capitalize first letter ---
const capitalize = (s: string) =>
  s.charAt(0).toUpperCase() + s.slice(1).replace(/-/g, " ");

// Pass districts list to script for client-side use
const allLocations = [...viennaDistricts, ...surroundingDistricts];
---

<section id="properties-filter" class="section-properties-filter-form">
  <div class="properties-filter-wrapper">
    <div id="property-filter-form" class="form-block">
      <form
        id="property-filter-form-element"
        name="property-filter-form"
        class="form"
      >
        <div id="mobile-summary-bar" class="filter-heading-tab">
          <div id="mobile-summary-text" class="filter-heading-tab-selection">
            Alle Filter Optionen
          </div>

          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="24px"
            viewBox="0 -960 960 960"
            width="24px"
            fill="currentColor"
            ><path
              d="M440-160q-17 0-28.5-11.5T400-200v-240L168-736q-15-20-4.5-42t36.5-22h560q26 0 36.5 22t-4.5 42L560-440v240q0 17-11.5 28.5T520-160h-80Zm40-308 198-252H282l198 252Zm0 0Z"
            ></path></svg
          >
          <!-- Add an icon here if desired, like an arrow down -->
        </div>
        <div id="mobile-expanded-content">
          <div id="filter-heading-bar" class="filter-heading-bar">
            <div class="mobile-close-button-wrapper">
              <button
                id="mobile-close-button"
                type="button"
                aria-label="Filter schließen"
              >
                &times;
              </button>
            </div>
            <div class="filter-group-mobile-wrapper">
              <div
                data-tab="immobilie"
                class="filter-heading-tab tab-container"
              >
                <div class="filter-heading-tab-name">Immobilie</div>
                <div
                  id="selection-immobilie"
                  class="filter-heading-tab-selection"
                >
                  Alle Kategorien
                </div>
              </div>
              <div id="panel-immobilie" class="filter-panel panel-immobilie">
                <div id="filter-vermarktungsart" class="filter-form-group">
                  <h2 class="filter-form-heading">Vermarktungsart</h2>
                  <div class="filter-form-input-wrapper radio-input-group">
                    <label class="radio-classic-label">
                      <input
                        type="radio"
                        name="vermarktungsart"
                        value="miete"
                      />Miete
                    </label>
                    <label class="radio-classic-label">
                      <input
                        type="radio"
                        name="vermarktungsart"
                        value="kauf"
                      />Kauf
                    </label>
                  </div>
                </div>
                <div id="filter-objektart" class="filter-form-group">
                  <h2 class="filter-form-heading">Objektart</h2>
                  {/* ... existing objektarten map ... */}
                  {
                    objektarten.length > 0 ? (
                      <div class="filter-form-input-wrapper checkbox-columns objektart-filter">
                        {objektarten.map((type) => (
                          <label class="checkbox-label">
                            <input
                              type="checkbox"
                              name="objektart"
                              value={type}
                              class="checkbox-input"
                            />
                            <span class="checkbox-text">{type}</span>
                          </label>
                        ))}
                      </div>
                    ) : (
                      <p>Keine Objektarten verfügbar.</p>
                    )
                  }
                </div>
                <a href="#" data-panel="immobilie" class="reset-button button"
                  >Zurücksetzen</a
                >
              </div>
            </div>

            <div class="filter-group-mobile-wrapper">
              <div data-tab="ort" class="filter-heading-tab tab-container">
                <div class="filter-heading-tab-name">Ort</div>
                <div id="selection-ort" class="filter-heading-tab-selection">
                  Alle Orte
                </div>
              </div>
              <div id="panel-ort" class="filter-panel panel-ort">
                {
                  Object.keys(districts).map((region) => (
                    <div class="filter-form-group">
                      <h2 class="filter-form-heading ">{region}</h2>
                      <div class="filter-form-input-wrapper checkbox-columns">
                        <div class="checkbox-column">
                          {districts[region]
                            .slice(0, Math.ceil(districts[region].length / 2))
                            .map((district) => (
                              <label class="checkbox-label">
                                <input
                                  type="checkbox"
                                  name="lage"
                                  value={district}
                                  class="checkbox-input"
                                />
                                <span class="checkbox-text">{district}</span>
                              </label>
                            ))}
                        </div>
                        <div class="checkbox-column">
                          {districts[region]
                            .slice(Math.ceil(districts[region].length / 2))
                            .map((district) => (
                              <label class="checkbox-label">
                                <input
                                  type="checkbox"
                                  name="lage"
                                  value={district}
                                  class="checkbox-input"
                                />
                                <span class="checkbox-text">{district}</span>
                              </label>
                            ))}
                        </div>
                      </div>
                    </div>
                  ))
                }
                <a href="#" data-panel="ort" class="reset-button button"
                  >Zurücksetzen</a
                >
              </div>
            </div>

            <div class="filter-group-mobile-wrapper">
              <div data-tab="groesse" class="filter-heading-tab tab-container">
                <div class="filter-heading-tab-name">Größe</div>
                <div
                  id="selection-groesse"
                  class="filter-heading-tab-selection"
                >
                  Jede Größe
                </div>
              </div>
              <div id="panel-groesse" class="filter-panel panel-groesse">
                <div class="filter-form-group">
                  <h2 class="filter-form-heading">Zimmer</h2>
                  <div class="number-input-wrapper">
                    <input
                      class="text-field"
                      name="zimmer-min"
                      placeholder="Min"
                      type="number"
                      id="filter-zimmer-min"
                    />
                    <div class="input-separator">bis</div>
                    <input
                      class="text-field"
                      name="zimmer-max"
                      placeholder="Max"
                      type="number"
                      id="filter-zimmer-max"
                    />
                  </div>
                </div>
                <div class="filter-form-group">
                  <h2 class="filter-form-heading">Fläche (m²)</h2>
                  <div class="number-input-wrapper">
                    <input
                      class="text-field"
                      name="flaeche-min"
                      placeholder="Min"
                      type="number"
                      id="filter-flaeche-min"
                    />
                    <div class="input-separator">bis</div>
                    <input
                      class="text-field"
                      name="flaeche-max"
                      placeholder="Max"
                      type="number"
                      id="filter-flaeche-max"
                    />
                  </div>
                </div>
                <a href="#" data-panel="groesse" class="reset-button button"
                  >Zurücksetzen</a
                >
              </div>
            </div>

            <div class="filter-group-mobile-wrapper">
              <div data-tab="preis" class="filter-heading-tab tab-container">
                <div class="filter-heading-tab-name">Preis</div>
                <div id="selection-preis" class="filter-heading-tab-selection">
                  Jeder Preis
                </div>
              </div>
              <div id="panel-preis" class="filter-panel panel-preis">
                {/* ... existing preis content ... */}
                <div class="filter-form-group price-group price-group-kauf">
                  <h2 class="filter-form-heading">Kaufpreis (€)</h2>
                  <div class="number-input-wrapper">
                    <input
                      class="text-field"
                      name="preis-kauf-min"
                      placeholder="Min"
                      type="number"
                      id="filter-preis-kauf-min"
                    />
                    <div class="input-separator">bis</div>
                    <input
                      class="text-field"
                      name="preis-kauf-max"
                      placeholder="Max"
                      type="number"
                      id="filter-preis-kauf-max"
                    />
                  </div>
                </div>

                <div class="filter-form-group price-group price-group-miete">
                  <h2 class="filter-form-heading">Miete (€)</h2>
                  <div class="number-input-wrapper">
                    <input
                      class="text-field"
                      name="preis-miete-min"
                      placeholder="Min"
                      type="number"
                      id="filter-preis-miete-min"
                    />
                    <div class="input-separator">bis</div>
                    <input
                      class="text-field"
                      name="preis-miete-max"
                      placeholder="Max"
                      type="number"
                      id="filter-preis-miete-max"
                    />
                  </div>
                </div>
                <a href="#" data-panel="preis" class="reset-button button"
                  >Zurücksetzen</a
                >
              </div>
            </div>

            <div class="filter-group-mobile-wrapper">
              <div
                data-tab="ausstattung"
                class="filter-heading-tab tab-container"
              >
                <div class="filter-heading-tab-name">Ausstattung</div>
                <div
                  id="selection-ausstattung"
                  class="filter-heading-tab-selection"
                >
                  Details
                </div>
              </div>
              <div
                id="panel-ausstattung"
                class="filter-panel panel-ausstattung"
              >
                <div class="filter-form-group">
                  <h2 class="filter-form-heading">Details</h2>
                  <div class="filter-form-input-wrapper checkbox-columns">
                    <div class="checkbox-column">
                      {
                        amenities
                          .slice(0, Math.ceil(amenities.length / 2))
                          .map((amenity) => (
                            <label class="checkbox-label">
                              <input
                                type="checkbox"
                                name="ausstattung"
                                value={amenity}
                                class="checkbox-input"
                              />
                              <span class="checkbox-text">
                                {capitalize(amenity)}
                              </span>
                            </label>
                          ))
                      }
                    </div>
                    <div class="checkbox-column">
                      {
                        amenities
                          .slice(Math.ceil(amenities.length / 2))
                          .map((amenity) => (
                            <label class="checkbox-label">
                              <input
                                type="checkbox"
                                name="ausstattung"
                                value={amenity}
                                class="checkbox-input"
                              />
                              <span class="checkbox-text">
                                {capitalize(amenity)}
                              </span>
                            </label>
                          ))
                      }
                    </div>
                  </div>
                </div>
                <a href="#" data-panel="ausstattung" class="reset-button button"
                  >Zurücksetzen</a
                >
              </div>
            </div>
            <div id="search-button" class="search-button-wrapper">
              <button type="submit" class="custom-submit-button">
                <Image
                  src={SearchIcon}
                  alt="Suchen"
                  width={24}
                  height={24}
                  class="search-icon"
                />
                 Suchen
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
<style>
  /* ==============================================================
  BASE STRUCTURE & LAYOUT
  ============================================================== */

  #properties-filter {
    /* box-shadow: 0 4px 2px -2px rgba(0, 0, 0, 0.2); */
    border-bottom: 2px solid rgba(47, 60, 53, 0.3);
  }
  .section-properties-filter-form {
    padding: var(--spacing-xl) 0;
    background-color: var(--color-brand-light-green);
  }

  .properties-filter-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--spacing-md);
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    position: relative;
    /* Reset z-index for mobile overlay */
    z-index: 10;
    transition: all 0.3s ease-in-out;
  }

  :global(.content-to-blur) {
    transition:
      filter 0.05s ease,
      transform 0.05s ease;
    filter: none;
    position: relative;
    z-index: 1;
    will-change: filter;
  }

  :global(body.is-filter-active) :global(.content-to-blur) {
    filter: blur(10px) brightness(1);
    transform: scale(1);
    pointer-events: none;
  }

  :global(.section-properties-filter-form) {
    position: relative;
  }
  :global(#filter-heading-bar) {
    z-index: 101;
  }
  :global(.filter-panel) {
    z-index: 100;
  }

  /* ==============================================================
  MOBILE SUMMARY BAR (Hidden by default, shown by media query)
  ============================================================== */
  #mobile-summary-bar {
    display: none;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md) var(--spacing-xl);
    cursor: pointer;
    background-color: var(--color-neutral-lightest);
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  #mobile-expanded-content {
    display: none;
  }

  /* ==============================================================
  FILTER HEADER (TABS)
  ============================================================== */
  .filter-heading-bar {
    position: relative;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--spacing-sm);
    background-color: var(--color-neutral-lightest);
    padding: var(--spacing-sm);
    border-radius: var(--border-radius);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  }

  .filter-group-mobile-wrapper {
    grid-column: span 1;
  }

  /* Global tab styles. Note: display is overridden for mobile collapsed state */
  .filter-heading-tab {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius);
    transition:
      background-color 0.2s,
      box-shadow 0.2s;
  }

  .filter-heading-tab.active {
    background-color: var(--color-neutral-green-grey);
  }

  .filter-heading-tab-selection {
    font-size: var(--font-size-body-small);
    font-weight: var(--font-weight-bold);
    color: var(--color-neutral-dark);
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  /* ==============================================================
  SEARCH BUTTON
  ============================================================== */

  .search-button-wrapper {
    grid-column: 6 / 7;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }

  .custom-submit-button {
    background-color: var(--color-brand-dark-green);
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    font-size: var(--font-size-body);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    height: 100%;
    transition: background-color 0.2s;
    margin-left: var(--spacing-sm);
  }

  .custom-submit-button:hover {
    background-color: var(--color-brand-medium-green);
  }

  .search-icon {
    width: 1.5em;
    height: 1.5em;
  }

  @media (max-width: 991px) {
    .custom-submit-button {
      margin-left: 0;
    }
  }

  /* ==============================================================
  FILTER PANELS (Desktop Dropdown & Mobile Accordion)
  ============================================================== */

  .filter-panel {
    /* --- DESKTOP DEFAULT / MOBILE ACCORDION BASE --- */
    background-color: var(--color-neutral-lightest);
    border: 1px solid var(--color-neutral-light);
    border-radius: var(--border-radius);
    z-index: 1;
    width: 50rem;

    /* MOBILE ACCORDION COLLAPSE STATE */
    max-height: 0;
    overflow: hidden;
    padding-top: 0;
    padding-bottom: 0;

    /* Transitions for both mobile (max-height) and desktop (opacity) */
    transition:
      max-height 0.4s ease-in-out,
      opacity 0.3s ease,
      padding 0.4s ease-in-out;
  }

  /* Active state for panel (used for both desktop and mobile) */
  .filter-panel.active {
    opacity: 1;
    pointer-events: auto;

    /* MOBILE ACCORDION EXPAND STATE */
    max-height: 2000px; /* Large enough to show all content */
    padding: var(--spacing-xl); /* Restore full padding for content */
  }

  .filter-form-group {
    margin-bottom: var(--spacing-lg);
  }

  .filter-form-heading {
    font-size: var(--font-size-h6);
    margin-bottom: var(--spacing-md);
    color: var(--color-neutral-dark);
  }
  .mobile-close-button-wrapper {
    display: none;
  }

  /* ==============================================================
  INPUT STYLES: RADIO/CHECKBOX
  ============================================================== */

  .radio-input-group {
    display: flex;
    gap: var(--spacing-xl);
  }

  .radio-classic-label,
  .checkbox-label {
    cursor: pointer;
    user-select: none;
    font-size: var(--font-size-body-small);
    color: var(--color-neutral-font-dark);
  }

  .radio-classic-label {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-neutral-green-grey);
  }

  .radio-classic-label input[type="radio"] {
    margin: 0;
  }

  .checkbox-columns {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: var(--spacing-md);
  }

  .checkbox-column {
    flex-basis: calc(50% - var(--spacing-md));
    flex-grow: 1;
    max-width: none;

    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .checkbox-label {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .checkbox-input {
    margin: 0;
  }

  /* ==============================================================
  INPUT STYLES: NUMBER/TEXT FIELDS
  ============================================================== */

  .number-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    max-width: 300px;
  }

  .text-field {
    padding: var(--spacing-sm);
    background-color: var(--color-neutral-green-grey);
    border: 1px solid var(--color-neutral-medium);
    border-radius: var(--border-radius-sm);
    width: 100px;
    height: 100%;
    flex-grow: 1;
    font-size: var(--font-size-body-small);
  }

  .input-separator {
    color: var(--color-neutral-medium);
    font-size: var(--font-size-body-small);
  }

  .price-group.hidden {
    display: none !important;
  }
  /* ==============================================================
  UTILITY & RESPONSIVENESS
  ============================================================== */

  .reset-button {
    margin-top: var(--spacing-md);
    display: inline-block;
    color: var(--color-brand-dark-green);
    text-decoration: underline;
    cursor: pointer;
    font-size: var(--font-size-body-small);
  }

  /* ==============================================================
  MOBILE EXPANDED OVERLAY & ACCORDION STATE
  ============================================================== */

  /* Full-screen overlay state */
  #property-filter-form-element.is-expanded {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    max-height: 100svh;
    overflow-y: hidden;
    background-color: var(--color-brand-light-green);
    z-index: 10001;
  }

  /* When expanded, show all tabs/accordion headers */
  #property-filter-form-element.is-expanded .filter-heading-tab {
    display: flex !important; /* Force show individual tabs */
    flex-direction: row;
    width: 100%;
    padding: var(--spacing-xl) var(--spacing-lg);
    border-bottom: 1px solid var(--color-neutral-light);
    cursor: pointer;
    background-color: var(--color-neutral-lightest);
  }

  /* Ensure the wrapper displays tabs as vertical blocks when expanded */
  #property-filter-form-element.is-expanded #filter-heading-bar {
    display: block;
    padding: 0;
  }

  /* Sticky summary bar when expanded */

  /* ==============================================================
  MOBILE STACKED ACCORDION LAYOUT (max-width: 991px)
  ============================================================== */

  @media (max-width: 991px) {
    .filter-form-heading {
      font-size: var(--font-size-h5);
    }
    .properties-filter-wrapper {
      width: 100%;
      margin: 0;
      padding: 0;
    }

    .form {
      gap: 0;
      width: 95%;
      position: relative;
      margin: 0 auto;
      transition: all 0s ease-in-out;
    }

    /* Show the mobile summary bar and hide individual tabs in collapsed state */
    #mobile-summary-bar {
      display: inline-flex;
      flex-direction: row;
      /* padding: 0 var(--spacing-md) */
    }
    #property-filter-form-element.is-expanded {
      height: 100vh;
      display: flex; /* NEW */
      flex-direction: column; /* NEW */
      justify-content: stretch;
      overflow-y: auto;
      padding: var(--spacing-sm) var(--spacing-sm);
      background-color: var(--color-neutral-transparent);
      backdrop-filter: blur(50px);
    }
  }
  #property-filter-form-element.is-expanded #mobile-summary-bar {
    display: none !important;
  }
  #property-filter-form-element.is-expanded #mobile-expanded-content {
    position: static;
    display: flex;
    flex-direction: column;
    flex-grow: 1 !important; /* Takes up all vertical space */
    overflow: hidden;
    z-index: 60;
    border-radius: 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    background-color: var(--color-neutral-transparent);
    font-size: var(--font-size-body-large: );
  }
  #property-filter-form-element.is-expanded #mobile-close-button {
    font-size: 2.5rem;
    background: none;
    border: none;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    z-index: 100;
    color: var(--color-neutral-dark-grey);
  }
  #property-filter-form-element.is-expanded .mobile-close-button-wrapper {
    display: flex;
    justify-content: end;
    height: 60px;
    background-color: var(--color-neutral-transparent);
    padding-right: var(--spacing-lg);
  }
  .filter-heading-tab {
    display: none; /* Hidden by default, shown by .is-expanded */
    transition:
      background-color 00s,
      box-shadow 0s;
  }
  .filter-heading-tab {
    font-size: var(--font-size-body-large);
  }
  .filter-heading-bar {
    display: flex;
    flex-direction: column;
  }
  .filter-heading-tab-selection {
    font-size: var(--font-size-body-large);
  }

  /* 1. Header (filter-heading-bar) becomes vertical accordion headers */
  #property-filter-form-element.is-expanded #filter-heading-bar {
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    gap: var(--spacing-md);
    padding: 0;
    box-shadow: none;
    width: 100%;
    height: 100%;
    background-color: var(--color-neutral-transparent);
  }
  .filter-group-mobile-wrapper {
    grid-column: auto;
    width: 100%;
  }

  /* 2. Individual Tabs (The accordion headers) - using is-expanded styles */
  .filter-heading-tab {
    justify-content: space-between;
    border-radius: var(--border-radius);
    margin-top: -1px;
    /* Other styles are inherited from .is-expanded specific rules */
  }

  /* Border/Rounding Logic (Kept from original mobile CSS) */
  .filter-group-mobile-wrapper:first-child .filter-heading-tab {
    margin-top: 0;
    border-top-left-radius: var(--border-radius);
    border-top-right-radius: var(--border-radius);
  }
  .filter-group-mobile-wrapper:last-of-type .filter-heading-tab {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }
  .filter-group-mobile-wrapper:last-of-type:not(:has(.filter-panel.active))
    .filter-heading-tab {
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
  }
  .filter-heading-tab.active {
    box-shadow: none;
    border-bottom: none;
    background-color: var(--color-neutral-lightest);
    font-weight: var(--font-weight-bold);
  }

  .number-input-wrapper {
    max-width: 100%;
    height: 3rem;
  }
  /* Place the search button visually below the accordion structure */
  #property-filter-form-element > .search-button-wrapper {
    display: block;
    flex-shrink: 0;
    padding-bottom: var(--spacing-md);
    background-color: var(--color-neutral-transparent);
  }
  .search-button-wrapper .custom-submit-button {
    width: 100%;
    height: auto;
    padding: var(--spacing-lg);
    font-size: var(--font-size-body-large);
  }

  /* 5. Panels (Accordion content) */
  .filter-panel {
    position: static; /* CRITICAL: Reset desktop absolute position */
    top: auto;
    left: 50%;

    width: 100%;
    margin-top: -1px;
    /* Set mobile-specific visibility/interaction properties for max-height transition */
    opacity: 1;
    pointer-events: auto;
    box-shadow: none;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border: 1px solid var(--color-neutral-light); /* Override desktop border */
    border-top: none; /* Connected to tab header */

    transition:
      max-height 0.1s ease-in-out,
      opacity 0.1s ease,
      padding 0.1s ease-in-out;
  }

  .filter-panel.active {
    /* If it's the last panel, give it a rounded bottom */
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
    border-bottom: 1px solid var(--color-neutral-light);
  }

  /* Reset columns for mobile checkbox layouts */
  .checkbox-columns {
    flex-wrap: wrap;
  }
  .checkbox-column {
    flex-basis: calc(50% - var(--spacing-md));
    flex-grow: 1;
    max-width: none;
  }

  .mobile-blur-div {
    backdrop-filter: blur(20px);
    opacity: 20%;
    background-color: white;
    flex: 1;
    height: 600px;
  }
  /* ==============================================================
  DESKTOP OVERRIDES (min-width: 992px)
  ============================================================== */

  @media (min-width: 992px) {
    .properties-filter-wrapper {
      position: relative; /* Ensure it stays static */

      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-md);
    }
    #mobile-expanded-content {
      display: flex !important; /* or flex, depending on content layout */
      position: static !important;
      height: auto !important;
      overflow: visible !important;
      flex-direction: row;
      /* Reset any mobile-specific layout properties */
    }

    /* Ensure the tab container inside also displays correctly */
    #filter-heading-bar {
      display: grid; /* Re-apply your desktop grid layout */
      grid-template-columns: repeat(6, 1fr);
      padding: var(--spacing-sm);
      /* Ensure no mobile styles like flex-direction: column are applied */
    }
    /* Hide the mobile summary bar and ensure individual tabs are shown */
    #mobile-summary-bar {
      display: none !important;
    }
    .filter-heading-tab {
      display: flex !important;
    }

    /* Reset form positioning and overflow from mobile overlay */
    #property-filter-form-element {
      position: relative;
      height: auto;
      overflow-y: visible;
    }

    .filter-panel {
      /* Re-apply desktop dropdown settings */
      display: none; /* Default state, hide all */
      position: absolute; /* Panels are absolute relative to the FORM */
      left: 50%;

      transform: none;
      transform: translateX(16%);
      /* Reset mobile accordion logic */
      max-height: none;
      overflow: visible;
      padding: var(--spacing-xl); /* Restore desktop padding */

      margin-top: 0;
      margin-bottom: 0;
      border-radius: var(--border-radius);
      border: 1px solid var(--color-neutral-light);

      /* Re-apply desktop shadow for the dropdown */
      box-shadow:
        0 10px 15px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05);
      width: 50rem;
    }

    /* Active state for panel (Desktop) */
    .filter-panel.active {
      display: block; /* Show via JS setting .active class */
      opacity: 1;
    }

    /* Ensure only desktop search button is used */
    #property-filter-form-element > .search-button-wrapper {
      display: none;
    }
    .filter-heading-bar .search-button-wrapper {
      display: flex;
    }
  }
</style>

<script define:vars={{ allLocations, viennaDistricts }}>
document.addEventListener("DOMContentLoaded", () => {
  const filterBar = document.getElementById("filter-heading-bar");
  const formElement = document.getElementById("property-filter-form-element");
  const mobileSummaryBar = document.getElementById("mobile-summary-bar");
  const mobileSummaryText = document.getElementById("mobile-summary-text");
  const mobileCloseButton = document.getElementById("mobile-close-button"); // NEW
  const priceGroupKauf = document.querySelector(".price-group-kauf");
  const priceGroupMiete = document.querySelector(".price-group-miete");

  // Define allTabs here for use in updateMobileSummaryText and listeners
  const tabsContainer = document.getElementById("filter-heading-bar");
  const allTabs = tabsContainer
    ? tabsContainer.querySelectorAll(
      ".filter-heading-tab:not(#mobile-summary-bar)"
    )
    : [];

  // Get references to the selection text elements
  const selectionImmobilie = document.getElementById("selection-immobilie");
  const selectionOrt = document.getElementById("selection-ort");
  const selectionGroesse = document.getElementById("selection-groesse");
  const selectionPreis = document.getElementById("selection-preis");
  const selectionAusstattung = document.getElementById(
    "selection-ausstattung"
  );

  // --- GLOBAL STATE ---
  let activePanelId = null; // Store ID of currently active panel (e.g., 'panel-immobilie')
  let activeTabElement = null; // Store reference to the currently active tab element

  // Safety check
  if (
    !filterBar ||
    !formElement ||
    !priceGroupKauf ||
    !priceGroupMiete ||
    !selectionImmobilie ||
    !selectionOrt ||
    !selectionGroesse ||
    !selectionPreis ||
    !selectionAusstattung
  )
    return;

  // --- Utility Function: Check for Mobile/Desktop View ---
  const isDesktop = () => window.matchMedia("(min-width: 992px)").matches;

  // --- DYNAMIC POSITIONING LOGIC (DESKTOP ONLY) ---
  /**
   * Calculates the position of the selected tab and moves the filter panel directly beneath it.
   * @param {HTMLElement} targetTab The tab element to align the panel under.
   * @param {HTMLElement} panelElement The panel element to position.
   */
  function positionPanel(targetTab, panelElement) {
    if (!isDesktop()) return; // Only apply dynamic positioning on desktop

    const filterBarRect = filterBar.getBoundingClientRect();
    const formRect = formElement.getBoundingClientRect();

    // The newLeft is the distance from the form's left edge to the filterBar's left edge.
    const newLeft = filterBarRect.left - formRect.left;

    // The newTop must place the panel at the bottom of the filter bar.
    const newTop = filterBar.offsetTop + filterBar.offsetHeight + 4; // Add a small gap (4px)

    // Apply the new position
    panelElement.style.left = `${newLeft}px`;
    panelElement.style.top = `${newTop}px`;
  }

  // --- Utility Function: Get Value or Null ---
  const getInputValue = (name) => {
    const input = formElement.querySelector(`[name="${name}"]`);
    // @ts-ignore
    return input?.value ? input.value : null;
  };

  // --- Utility Function: Format Price ---
  const formatPrice = (price) => {
    if (price === null || isNaN(Number(price))) return "";
    return new Intl.NumberFormat("de-DE", {
      maximumFractionDigits: 0,
    }).format(Number(price));
  };

  // --- Utility Function: Reset Form Fields ---
  const resetAllFormFields = () => {
    formElement.querySelectorAll("input, select").forEach((input) => {
      // @ts-ignore
      if (input.type === "checkbox" || input.type === "radio") {
        // Uncheck all checkboxes and radios
        input.checked = false;
      } else if (input.tagName === "SELECT") {
        input.selectedIndex = 0;
      } else {
        // Reset text and number inputs
        input.value = "";
      }
    });
  };

  // --- MOBILE LOGIC: Update the collapsed summary bar text (MODIFIED) ---
  function updateMobileSummaryText() {
    // Check if we are on mobile view
    if (!mobileSummaryText || isDesktop()) return;

    const selections = Array.from(allTabs)
      .map((tab) => {
        const selectionElement = tab.querySelector(
          ".filter-heading-tab-selection"
        );
        return selectionElement ? selectionElement.textContent : "";
      })
      .filter(
        (text) =>
          text &&
          text.trim() !== "Alle Kategorien" &&
          text.trim() !== "Alle Orte" &&
          text.trim() !== "Jede Größe" &&
          text.trim() !== "Jeder Preis" &&
          text.trim() !== "Details"
      );

    if (selections.length > 0) {
      mobileSummaryText.textContent = selections.join(", ");
    } else {
      mobileSummaryText.textContent = "Alle Filter Optionen";
    }
  }

  function closeMobileModal() {
    if (isDesktop()) return;

    // 1. Collapse the entire menu (modal)
    formElement.classList.remove("is-expanded");
    document.body.classList.remove("is-filter-active");

    // 2. Ensure all panels and active states are closed
    document
      .querySelectorAll(".filter-panel")
      .forEach((p) => p.classList.remove("active"));
    document
      .querySelectorAll(".filter-heading-tab")
      .forEach((t) => t.classList.remove("active"));

    activePanelId = null;
    activeTabElement = null;
  }

  function handleMobileSummaryClick() {
    const isExpanded = formElement.classList.contains("is-expanded");

    if (isDesktop()) return;

    if (!isExpanded) {
      // Step 1: Expand the entire menu
      formElement.classList.add("is-expanded");

      // Step 2: Automatically open the first panel ('immobilie')
      const firstTab = document.querySelector('[data-tab="immobilie"]');
      if (firstTab) {
        // Use a short delay to ensure expansion transition starts before panel opens
        setTimeout(() => {
          // Pass true to force the panel to open
          togglePanel(firstTab, true);
        }, 50);
      }
    } else {
      // If expanded, clicking the summary bar collapses the filter entirely
      formElement.classList.remove("is-expanded");

      // Ensure all panels and active states are closed
      document
        .querySelectorAll(".filter-panel")
        .forEach((p) => p.classList.remove("active"));
      document
        .querySelectorAll(".filter-heading-tab")
        .forEach((t) => t.classList.remove("active"));

      activePanelId = null;
      activeTabElement = null;
      document.body.classList.remove("is-filter-active");
    }
  }

  // --- CORE LOGIC: UPDATE TAB SELECTION TEXTS ---
  const updateTabSelections = () => {
    const formData = new FormData(formElement);

    // --- 1. IMMOBILIE (vermarktungsart, objektart) ---
    const vmArt = formData.get("vermarktungsart");
    const objArts = formData.getAll("objektart").filter((v) => v.length > 0);

    let immobilietext = "Alle Kategorien";
    const vmAction = vmArt === "miete" ? "mieten" : "kaufen";
    const vmType = vmArt === "miete" ? "Mieten" : "Kaufen";

    if (vmArt && objArts.length === 0) {
      immobilietext = vmType;
    } else if (vmArt && objArts.length === 1) {
      immobilietext = `${objArts[0]} ${vmAction}`;
    } else if (vmArt && objArts.length > 1) {
      immobilietext = `${objArts.length} Objektarten ${vmAction}`;
    } else if (!vmArt && objArts.length === 1) {
      immobilietext = objArts[0];
    } else if (!vmArt && objArts.length > 1) {
      immobilietext = `${objArts.length} Objektarten`;
    }

    selectionImmobilie.textContent = immobilietext;

    // --- 2. ORT (lage) ---
    const selectedLages = formData.getAll("lage").filter((v) => v.length > 0);
    let ortText = "Alle Orte";

    if (selectedLages.length === 1) {
      const selectedLage = selectedLages[0];
      // Note: viennaDistricts is expected to be available in this scope via define:vars
      // Assuming capitalization is handled externally or not critical here
      if (
        Array.isArray(viennaDistricts) &&
        viennaDistricts.includes(selectedLage)
      ) {
        ortText = selectedLage;
      } else {
        ortText = selectedLage;
      }
    } else if (selectedLages.length > 1) {
      ortText = `${selectedLages.length} Orte`;
    }

    selectionOrt.textContent = ortText;

    // --- 3. GRÖSSE (zimmer, flaeche) ---
    let zimmerMin = getInputValue("zimmer-min");
    let zimmerMax = getInputValue("zimmer-max");
    let flaecheMin = getInputValue("flaeche-min");
    let flaecheMax = getInputValue("flaeche-max");

    let zimmerText = "";
    if (zimmerMin && zimmerMax) {
      zimmerText = `${zimmerMin} - ${zimmerMax} Zimmer`;
    } else if (zimmerMin) {
      zimmerText = `ab ${zimmerMin} Zimmer`;
    } else if (zimmerMax) {
      zimmerText = `bis ${zimmerMax} Zimmer`;
    }

    let flaecheText = "";
    if (flaecheMin && flaecheMax) {
      flaecheText = `${flaecheMin} - ${flaecheMax} m²`;
    } else if (flaecheMin) {
      flaecheText = `ab ${flaecheMin} m²`;
    } else if (flaecheMax) {
      flaecheText = `bis ${flaecheMax} m²`;
    }

    let groesseText = "Jede Größe";
    if (zimmerText && flaecheText) {
      groesseText = `${zimmerText}, ${flaecheText}`;
    } else if (zimmerText) {
      groesseText = zimmerText;
    } else if (flaecheText) {
      groesseText = flaecheText;
    }

    selectionGroesse.textContent = groesseText;

    // --- 4. PREIS (price-kauf/miete) ---
    let kaufMin = getInputValue("preis-kauf-min");
    let kaufMax = getInputValue("preis-kauf-max");
    let mieteMin = getInputValue("preis-miete-min");
    let mieteMax = getInputValue("preis-miete-max");

    let kaufRange = "";
    let mieteRange = "";

    if (kaufMin || kaufMax) {
      if (kaufMin && kaufMax) {
        kaufRange = `${formatPrice(kaufMin)} - ${formatPrice(kaufMax)} €`;
      } else if (kaufMin) {
        kaufRange = `ab ${formatPrice(kaufMin)} €`;
      } else if (kaufMax) {
        kaufRange = `bis ${formatPrice(kaufMax)} €`;
      }
    }

    if (mieteMin || mieteMax) {
      if (mieteMin && mieteMax) {
        mieteRange = `${formatPrice(mieteMin)} - ${formatPrice(mieteMax)} €/Monat`;
      } else if (mieteMin) {
        mieteRange = `ab ${formatPrice(mieteMin)} €/Monat`;
      } else if (mieteMax) {
        mieteRange = `bis ${formatPrice(mieteMax)} €/Monat`;
      }
    }

    let preisText = "Jeder Preis";

    if (vmArt === "kauf") {
      preisText = kaufRange || "Jeder Preis";
    } else if (vmArt === "miete") {
      preisText = mieteRange.replace("/Monat", "") || "Jeder Preis";
    } else {
      if (kaufRange && mieteRange) {
        preisText = "Kauf & Miete";
      } else if (kaufRange) {
        preisText = kaufRange;
      } else if (mieteRange) {
        preisText = mieteRange.replace("/Monat", "");
      }
    }
    selectionPreis.textContent = preisText;

    // --- 5. AUSSTATTUNG (ausstattung) ---
    const selectedAmenities = formData
      .getAll("ausstattung")
      .filter((v) => v.length > 0);
    let ausstattungText = "Details";

    if (selectedAmenities.length === 1) {
      // Assuming a capitalize function exists or just use the raw value
      ausstattungText = selectedAmenities[0]; // Removed capitalize() for safety
    } else if (selectedAmenities.length > 1) {
      ausstattungText = `${selectedAmenities.length} Details`;
    }
    selectionAusstattung.textContent = ausstattungText;

    // Always update the mobile summary bar after updating individual selections
    updateMobileSummaryText();
  };

  // --- Price Group Visibility Logic (Used on init and on 'immobilie' change) ---
  function handleVermarktungsartChange() {
    const vmArt = getInputValue("vermarktungsart");

    // Hide both first
    priceGroupKauf.classList.add("hidden");
    priceGroupMiete.classList.add("hidden");

    if (vmArt === "miete") {
      priceGroupMiete.classList.remove("hidden");
    } else if (vmArt === "kauf") {
      priceGroupKauf.classList.remove("hidden");
    } else {
      // Show both if nothing is selected (default)
      priceGroupKauf.classList.remove("hidden");
      priceGroupMiete.classList.remove("hidden");
    }
  }

  // --- CORE LOGIC: TOGGLE PANEL VISIBILITY (MODIFIED) ---
  /**
   * Toggles the visibility and active state of a filter tab and its associated panel.
   * @param {HTMLElement} targetTab The tab element that was clicked.
   * @param {boolean} [forceOpen=false] If true, forces the panel to open even if it's currently inactive.
   */
  function togglePanel(targetTab, forceOpen = false) {
    const tabName = targetTab.getAttribute("data-tab");
    const panelId = `panel-${tabName}`;
    const panelElement = document.getElementById(panelId);

    if (!panelElement) return;

    const isActive = targetTab.classList.contains("active");
    const isMobileView = !isDesktop();

    // 1. Determine if we should OPEN or CLOSE
    const shouldOpen = forceOpen || !isActive;

    // 2. Close All First
    document.querySelectorAll(".filter-panel").forEach((p) => {
      p.classList.remove("active");
      if (!isMobileView) {
        // Only manipulate display property on Desktop
        p.style.display = "none";
      }
    });
    document.querySelectorAll(".filter-heading-tab").forEach((t) => {
      t.classList.remove("active");
    });

    // 3. Open or Remain Closed
    if (shouldOpen) {
      // Open the new panel
      targetTab.classList.add("active");
      panelElement.classList.add("active");

      if (!isMobileView) {
        // Desktop logic: Show and Position
        panelElement.style.display = "block";
        positionPanel(targetTab, panelElement);
        document.body.classList.add("is-filter-active");
      }

      activePanelId = panelId;
      activeTabElement = targetTab;
    } else {
      // Panel was active and clicked again -> close it
      activePanelId = null;
      activeTabElement = null;
      document.body.classList.remove("is-filter-active");
    }

    handleVermarktungsartChange();
  }

  // --- CORE LOGIC: SETUP EVENT LISTENERS ---
  const setupEventListeners = () => {
    // NEW: Attach listener to the mobile summary bar
    if (mobileSummaryBar) {
      mobileSummaryBar.addEventListener("click", handleMobileSummaryClick);
    }
    if (mobileCloseButton) {
      mobileCloseButton.addEventListener("click", closeMobileModal);
    }

    // Listen for tab clicks to toggle panels (MODIFIED)
    filterBar.addEventListener("click", (e) => {
      const targetTab = e.target.closest(".tab-container");
      if (!targetTab) return;

      const isMobileExpanded = formElement.classList.contains("is-expanded");

      if (!isDesktop()) {
        // On mobile, only allow tab clicks if the menu is expanded
        if (isMobileExpanded) {
          togglePanel(targetTab);
        }
      } else {
        // Desktop behavior
        togglePanel(targetTab);
      }
    });

    document.querySelectorAll(".reset-button").forEach((button) => {
      button.addEventListener("click", (e) => {
        e.preventDefault();

        resetAllFormFields();

        // Update UI
        updateTabSelections();
        handleVermarktungsartChange();

        // Dispatch filter event
        const formData = new FormData(formElement);
        const filterEvent = new CustomEvent("filter:submit", {
          detail: { formData: formData },
        });
        document.dispatchEvent(filterEvent);
      });
    });

    // --- Global click listener to close panel when clicking outside (Desktop only) ---
    document.addEventListener("click", (e) => {
      // Only run on desktop, and only if a panel is active
      if (!isDesktop() || !activePanelId) return;

      const activePanel = document.getElementById(activePanelId);
      if (!activePanel) return;

      const isClickInsidePanel = activePanel.contains(e.target);
      const isClickInsideBar = filterBar.contains(e.target);

      if (!isClickInsidePanel && !isClickInsideBar) {
        // Clicked outside both the bar and the active panel
        activePanel.classList.remove("active");
        activePanel.style.display = "none"; // Explicitly hide
        activeTabElement?.classList.remove("active");
        activePanelId = null;
        activeTabElement = null;
        document.body.classList.remove("is-filter-active");
      }
    });

    // --- Reposition panel on window resize & Mobile cleanup (MODIFIED) ---
    window.addEventListener("resize", () => {
      // Only run if a panel is currently open and we are on desktop
      if (activePanelId && activeTabElement && isDesktop()) {
        positionPanel(
          activeTabElement,
          document.getElementById(activePanelId)
        );
      }

      // NEW: If resizing to desktop, close the mobile expanded state
      if (isDesktop()) {
        formElement.classList.remove("is-expanded");
        // Ensure mobile-specific active states are also cleared
        document.body.classList.remove("is-filter-active");
      } else {
        // If resizing to mobile, ensure desktop display none is removed if expanded
        if (formElement.classList.contains("is-expanded")) {
          document.querySelectorAll(".filter-panel").forEach((p) => {
            p.style.display = "";
          });
        }
      }
    });

    // --- Input listeners for state management and text updates ---
    formElement.addEventListener("input", updateTabSelections);

    //search button listener
    // Function to check if any form field has a non-empty/non-default value.
    // It returns true if a search should be executed, false otherwise.
    const hasMeaningfulInput = (formData) => {
      // Define values that should NOT trigger a search (defaults/empties)
      const defaultValues = ["", "0", "unbekannt", "egal"];

      for (const [key, value] of formData.entries()) {
        const trimmedValue = String(value).trim().toLowerCase();

        // Ignore known non-input fields like the button name itself if present
        if (key.startsWith("btn-") || key.startsWith("submit-")) {
          continue;
        }

        // Check if the value is NOT one of the defined default/empty states
        // This is the core logic: if we find *any* non-default value, we execute the search.
        if (!defaultValues.includes(trimmedValue)) {
          return true;
        }
      }

      // If the loop finishes without finding any meaningful input, don't search.
      return false;
    };

    formElement.addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData(formElement);

      // 1. Check for meaningful input
      if (hasMeaningfulInput(formData)) {
        // 2. ONLY DISPATCH EVENT IF INPUT IS FOUND
        const filterEvent = new CustomEvent("filter:submit", {
          detail: { formData: formData },
        });
        document.dispatchEvent(filterEvent);
      } else {
        // OPTIONAL: Provide feedback to the user
        console.log("Search blocked: No filters selected.");
        // You might want to display a message on the UI here, e.g.,
        // alert("Bitte wählen Sie mindestens einen Filter aus.");
      }

      // 3. Close the filter panel regardless of whether a search ran
      if (activePanelId) {
        const activePanel = document.getElementById(activePanelId);
        activePanel.classList.remove("active");
        if (isDesktop()) {
          activePanel.style.display = "none";
        }
        activeTabElement?.classList.remove("active");
        activePanelId = null;
        activeTabElement = null;
        document.body.classList.remove("is-filter-active");
      }

      // Also close mobile expanded state on submit
      formElement.classList.remove("is-expanded");
    });

    // Add change listener for Vermarktungsart
    document.querySelectorAll('[name="vermarktungsart"]').forEach((input) => {
      input.addEventListener("change", () => {
        handleVermarktungsartChange();
        updateTabSelections();
      });
    });

    // Add change listeners for all other inputs (needed for updates even if panel is closed)
    document
      .querySelectorAll(".filter-panel input, .filter-panel select")
      .forEach((input) => {
        input.addEventListener("change", updateTabSelections);
      });

    // Run initial state setup
    handleVermarktungsartChange();
  };

  setupEventListeners();
  updateTabSelections(); // Initial text update
});
</script>
