---
import AgentContactForm from "../../Base/AgentContactForm.tsx";
// Assuming PropertyListing receives propertyDataJson as a string prop:
const { propertyDataJson, googleMapsEmbedUrl } = Astro.props; 
import docIcon from "./../../../assets/images/Document-icon-svg.svg"
import openInNewWindow from "../../../assets/images/Open-in-new-window.svg"
import SkeletonPropertyListing from "./SkeletonPropertyListing.astro";


// 1. Define a variable for the parsed data
let propertyData = null;

// 2. Parse the JSON string safely within the frontmatter
try {
  if (propertyDataJson) {
    propertyData = JSON.parse(propertyDataJson);
  }
} catch (e) {
  console.error("Failed to parse property data JSON:", e);
  // propertyData remains null if parsing fails
}
---

<div id="app-container" class="site-container property-container">
  <SkeletonPropertyListing />

  <!-- Main Content Area -->
  <div id="property-listing-content" style="display: none;">
    <!-- Title and Header Area -->
    

    <!-- Image Gallery -->
    <section class="image-section">
      <div class="main-image-box">
        <img
          id="main-gallery-image"
          src="https://placehold.co/1200x800/e5e7eb/6b7280?text=Hauptbild"
          alt="Hauptansicht der Immobilie"
          class="main-image"
        />

        <!-- Gallery Navigation Controls -->
        <div class="gallery-controls-wrapper">
          <button
            id="prev-button"
            class="gallery-nav-button"
            aria-label="Vorheriges Bild anzeigen"
          >
            &#10094; <!-- Unicode Left Arrow -->
          </button>
          <button
            id="next-button"
            class="gallery-nav-button"
            aria-label="Nächstes Bild anzeigen"
          >
            &#10095; <!-- Unicode Right Arrow -->
          </button>
        </div>

        <button id="fullscreen-toggle" class="fullscreen-toggle-button">
          &#x26F6; Vollbild
        </button>
      </div>
      <!-- Thumbnails -->
      <div id="gallery-thumbnails" class="gallery-thumbnails-scroll">
        <!-- Thumbnails rendered here by JS -->
      </div>
    </section>
    <header class="listing-header">
      <h1 id="listing-title" class="listing-title"></h1>
      <p id="listing-address" class="listing-address"></p>
      <div class="header-meta">
        <span id="listing-price" class="listing-price"></span>
        <span id="listing-type" class="listing-type-tag"></span>
      </div>
    </header>
    <div class="listing-grid">
      <!-- Left Column (Details & Description) -->
      <div class="main-details">
        <section class="key-facts-card">
          <div id="key-facts" class="key-facts-grid"></div>
        </section>

        <section class="listing-section">
          <h2 class="section-header">Objektbeschreibung</h2>
          <p id="property-description" class="description-content"></p>
        </section>

        <section class="listing-section">
          <h2 class="section-header">Ausstattung</h2>
          <div id="ausstattung-details" class="description-content"></div>
        </section>

        <section class="listing-section">
          <h2 class="section-header">Lage</h2>
          <p id="location-description" class="location-description-content"></p>
          <div class="map-embed-container">
            <iframe
              src={googleMapsEmbedUrl}
              style="border:0;"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </section>
      </div>

      <!-- Right Column (Sticky Sidebar: Agent Card & Fact Box) -->
      <div class="sidebar-wrapper">
        <div class="sidebar-sticky">
          <div class="sidebar-card agent-card">
            <h2>Ihr Ansprechpartner</h2>
            <div id="agent-card" class="agent-card">
              <div class="agent-info">
              <img
                id="agent-image"
                src="https://placehold.co/100x100/e5e7eb/6b7280?text=M"
                alt="Maklerbild"
                class="agent-image"
                loading="lazy"
              />
              <p id="agent-name" class="agent-name"></p>
              <p id="agent-phone" class="agent-phone"></p>
              <p id="agent-email" class="agent-email"></p>
            </div>
              <AgentContactForm client:load property={propertyData}/>
            </div>
          </div>

          <div class="sidebar-card fact-box">
            <h2>Objekdetails</h2>
            <dl id="fact-box-list" class="fact-box-list"></dl>
            
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fullscreen Modal Gallery -->
<div id="fullscreen-gallery-modal" class="fullscreen-modal-overlay">
  <button
    id="modal-close"
    class="modal-close-button"
    aria-label="Vollbild schließen"
  >
    &times;
  </button>
  <div class="modal-content-wrapper">
    <button
      id="modal-prev"
      class="modal-nav-button"
      aria-label="Vorheriges Bild"
    >
      &#10094;
    </button>
    <div class="modal-image-box">
      <img id="modal-image" src="" alt="Vollbildansicht" class="modal-image" />
    </div>
    <button id="modal-next" class="modal-nav-button" aria-label="Nächstes Bild">
      &#10095;
    </button>
  </div>
</div>

<style>
  body {
    background-color: var(--color-neutral-lightest);
  }
  .property-container {
    padding: var(--spacing-4xl) var(--spacing-md);
    background-color: var(--color-neutral-lightest);

    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
  }

  .main-fact-icon {
    color: var(--color-brand-green);
  }
  .section-separator {
    border-top: 1px solid var(--color-neutral-light-grey);
    margin: var(--spacing-2xl) 0;
  }

  /* Custom scrollbar for gallery thumbnails */
  .gallery-thumbnails-scroll {
    overflow-x: auto;
    height: 7rem;
    gap: var(--spacing-md);
    display: flex;
    padding-bottom: var(--spacing-sm); /* space for scrollbar */
    opacity: 60%;
  }
  .gallery-thumbnails-scroll::-webkit-scrollbar {
    height: 6px;
  }
  .gallery-thumbnails-scroll::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: var(--border-radius);
  }

  /* Style for Sanity Portable Text list */
  /* .portable-text-list {
    list-style: none;
    padding-left: 0;
    margin-top: var(--spacing-md);
  }*/
  .portable-text-list {
    list-style:circle
    position: relative;
    padding-left: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-body-base);
  }
  /* .portable-text-list::before {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--color-brand-green);
    font-weight: var(--font-weight-bold);
  } */
   .listing-header {
    margin-bottom: var(--spacing-2xl);
  }
  .listing-title {
    font-size: 1.8rem;
    font-family: var(--font-header);
    color: var(--color-brand-medium-green);
    hyphens: auto;
  }
  .listing-address {
    font-size: var(--font-size-body-large);
    color: var(--color-neutral-font-dark);
    margin-top: var(--spacing-sm);
  }
  .header-meta {
    margin-top: var(--spacing-md);
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    align-items: center;
  }
  .listing-price {
    font-size: var(--font-size-h4);
    font-weight: var(--font-weight-bold);
    color: var(--color-neutral-font-dark);
  }
  .listing-type-tag {
    font-size: var(--font-size-body-small);
    font-weight: var(--font-weight-semi-bold);
    color: var(--color-neutral-dark-grey);
    border: 1px solid var(--color-neutral-medium-grey);
    border-radius: 9999px;
    padding: var(--spacing-sm) var(--spacing-md);
  }

  /* Image Gallery */
  /* This container uses the padding hack for a 3:2 responsive ratio */
  .image-section {
    margin-bottom: var(--spacing-xl);
    max-height: calc(60vh - 4.0625rem);
    min-height: 40rem;
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .main-image-box {
    width: 100%;
    height: 0;
    position: relative;
    flex-grow: 1;
    overflow: hidden;
    border-radius: var(--border-radius);
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(185, 160, 160, 0.05);
    background-color: var(--color-neutral-light-grey);
    display: flex;
    flex-direction: column;
    position: relative;
  }
  .main-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
  }
  .thumbnail-image {
    width: 96px;
    height: 40px;
    object-fit: cover;
    border-radius: var(--border-radius);
    border: 2px solid transparent;
    transition: border-color 0.2s;
    flex-shrink: 0;
    cursor: pointer;
  }
  .thumbnail-image:hover,
  .thumbnail-image.active {
    border-color: var(--color-brand-green);
    cursor: pointer;
  }

  /* --- Gallery Navigation Controls --- */
  .gallery-controls-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    pointer-events: none;
  }
  .gallery-nav-button,
  .modal-nav-button {
    pointer-events: all;
    background-color: var(--color-neutral-lightest);
    color: var(--color-neutral-font-dark);
    border: 1px solid var(--color-neutral-light-grey);
    padding: var(--spacing-md);
    margin: var(--spacing-lg);
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: var(--font-size-h4);
    line-height: 1;
    transition:
      background-color 0.2s,
      opacity 0.2s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .gallery-nav-button:hover,
  .modal-nav-button:hover {
    background-color: var(--color-neutral-light-grey);
    color: var(--color-neutral-font-dark);
  }
  .fullscreen-toggle-button {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    pointer-events: all;
    background-color: var(--color-neutral-dark-grey);
    color: var(--color-neutral-white);
    border: none;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius);
    font-size: var(--font-size-body-small);
    font-weight: var(--font-weight-semi-bold);
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .fullscreen-toggle-button:hover {
    background-color: rgba(0, 0, 0, 0.7);
  }

  /* --- Fullscreen Modal Styles --- */
  .fullscreen-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    margin-top: 7.5rem;
    background-color: var(--color-brand-dark-green);
    z-index: 1000;
    display: none; /* Controlled by JS */
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .fullscreen-modal-overlay.active {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    opacity: 1;
  }

  .modal-close-button {
    position: absolute;
    top: var(--spacing-xl);
    right: var(--spacing-xl);
    background: none;
    border: none;
    color: var(--color-neutral-white);
    font-size: var(--font-size-h1);
    cursor: pointer;
    z-index: 1010;
    opacity: 0.8;
    transition: opacity 0.2s;
  }
  .modal-close-button:hover {
    opacity: 1;
  }

  .modal-image-box {
    width: 100%;
    max-width: 100vw;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }
  .modal-image {
    max-height: 100%;
    object-fit: fill;
    border-radius: var(--border-radius);
    box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
  }
  .modal-nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;

    /* OVERRIDE: Change text color to white for visibility on the dark modal background */

    display: flex;
    align-items: center;
    justify-content: center;
  }

  #modal-prev {
    left: var(--spacing-md);
  }

  #modal-next {
    right: var(--spacing-md);
  }

  .modal-content-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    position: relative;
  }
  /* End Fullscreen Modal Styles */

  /* Main Grid Layout - The core responsiveness change is here */
  .listing-grid {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4xl);
  }

  /* Desktop Layout: Switch to two columns at 1024px+ */
  @media (min-width: 1024px) {
    .property-container {
      padding: var(--spacing-4xl) var(--spacing-xl);
    }
    .listing-grid {
      display: grid; /* Switched from flex to grid */
      grid-template-columns: 2fr 1fr; /* Two columns: 2/3 for content (image), 1/3 for sidebar */
      gap: var(--spacing-2xl);
    }
    .sidebar-sticky {
      position: sticky;
      top: var(--spacing-xl);
      align-self: flex-start;
    }
    .listing-title {
      font-size: 2.5rem;
    }
    .listing-price {
      font-size: var(--font-size-h3);
    }
    .listing-address {
      font-size: var(--font-size-body-xlarge);
    }
    .fullscreen-modal-overlay {
      margin-top: 4.0625rem;
    }
  }

  /* Key Facts Card & other sections (styles omitted for brevity but present in original) */
  .key-facts-card {
    padding: var(--spacing-lg);
    /* background-color: var(--color-neutral-green-grey); */
    color: var(--color-neutral-font-dark);
    /* border: solid 2px var(--color-brand-medium-green); */
    border-radius: var(--border-radius);
    /* box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); */
    margin-bottom: var(--spacing-2xl);
    box-shadow: 0px 4px 8px var(--color-neutral-green-grey);
    border: solid 2px var(--color-neutral-green-grey);
  }
  .key-facts-card h2 {
    font-size: var(--font-size-h4);
    margin-bottom: var(--spacing-lg);
  }
  .key-facts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    text-align: center;
  }
  @media (min-width: 640px) {
    .key-facts-grid {
      grid-template-columns: repeat(4, 1fr);
      width: 100%;
    }
  }
  .fact-item {
    padding: var(--spacing-md);
    background-color: var(--color-neutral-light-grey);
    border-radius: var(--border-radius);
  }
  .fact-item-value {
    font-size: var(--font-size-h5);
    font-weight: var(--font-weight-bold);
    color: var(--color-neutral-font-dark);
    margin-top: var(--spacing-sm);
  }
  .fact-item-label {
    font-size: var(--font-size-body-xsmall);
    color: var(--color-neutral-dark-grey);
    text-transform: uppercase;
    font-weight: var(--font-weight-semi-bold);
    margin-top: var(--spacing-sm);
  }


  #ausstattung-details {
list-style: circle;  }

  .listing-section {
    display: flex;
    flex-direction: column;
  }

  .section-header {
    font-size: var(--font-size-h3);
    font-family: var(--font-header);
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  .description-content,
  .location-description-content {
    color: var(--color-neutral-dark-grey);
    line-height: var(--line-height-body);
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-body-large);
    word-break: break-all;
  }

  .map-embed-container {
    /* Define the size for the map */
    width: 100%;
    height: 300px; /* Adjust height as needed */
    margin-top: var(--spacing-lg);
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .map-embed-container iframe {
    width: 100%;
    height: 100%;
    display: block;
  }
  .complex-features-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
  }
  .feature-tag {
    background-color: var(--color-neutral-light-grey);
    color: var(--color-neutral-font-dark);
    font-size: var(--font-size-body-small);
    font-weight: var(--font-weight-semi-bold);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: 9999px;
    white-space: nowrap;
  }

  .floorplan-box {
    width: 100%;
    height: 400px;
    max-width: 500px;
    background-color: var(--color-neutral-light-grey);
    border-radius: var(--spacing-lg);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-neutral-medium-grey);
    margin-top: var(--spacing-lg);
    overflow: hidden;
  }
  .floorplan-box img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: var(--spacing-md);
  }

  .sidebar-card {
    padding: var(--spacing-xl);
    border-radius: var(--border-radius);
    box-shadow: 0px 4px 8px var(--color-neutral-green-grey);
    margin-bottom: var(--spacing-xl);
    border: solid 2px var(--color-neutral-green-grey);
  }
  .sidebar-card h2 {
    font-size: var(--font-size-h4);
    font-weight: var(--font-weight-bold);
    border-bottom: 1px solid var(--color-neutral-light-grey);
    padding-bottom: var(--spacing-md);
    margin-bottom: var(--spacing-md);
  }
  .agent-card {
    text-align: center;
  }
  .agent-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-lg);

  }
  .agent-image {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    margin: 0 auto var(--spacing-md) auto;
    object-fit: cover;
    object-position: 50% 0%;
    border: 3px solid var(--color-brand-medium-green);
  }
  .agent-name {
    font-size: var(--font-size-body-large);
    font-weight: var(--font-weight-semi-bold);
  }
  .agent-phone, .agent-email {
    font-size: var(--font-size-body-small);
    color: var(--color-neutral-dark-grey);
  }
  .agent-email {
    text-decoration: underline;

  }
  .contact-button {
    padding: var(--spacing-lg);
  }

  .fact-box-list {
  /* Use CSS Grid to organize <dt> and <dd> into two columns */
  display: grid;
  /* flex-direction: column; */
  grid-template-columns: max-content max-content; 
   gap: 8px ; /* Row and column spacing */
  margin: 0;
  padding: 0;
}

.fact-detail-row {
  display: flex;
  min-width: fit-content;
}

.fact-title {
  /* Description Term (e.g., "Wohnfläche") */
  font-weight: var(--font-weight-regular, 400); /* Keep title regular weight */
  color: var(--color-neutral-dark); /* Slightly less prominent color */
  text-align: left;
  /* Ensure the title stays in its column */
  grid-column: 1; 
  /* Remove browser default margins */
  margin: 0;
}

.fact-data dd.fact-data{
  /* Description Data (e.g., "120 m²") */
  font-weight: var(--font-weight-bold, 700) !important; 
  color: var(--color-neutral-font-dark);
  text-align: right; /* Align data to the right */
  /* Ensure the data stays in its column */
  grid-column: 2; 
  /* Remove browser default margins */
  margin: 0;
}
.download-link {
  /* Mimic the button/link style */
  display: block;
  width: 100%;
  text-align: center;
  padding: var(--spacing-md) var(--spacing-lg);
  margin-top: var(--spacing-lg); /* Space it out from the fact list */
  border-radius: var(--border-radius);
  
  /* Appearance */
  background-color: var(--color-brand-medium-green);
  color: var(--color-neutral-white); 
  text-decoration: none;
  font-weight: var(--font-weight-bold);
  transition: background-color 0.2s ease;
}

.download-link:hover {
  background-color: var(--color-brand-dark-green);
}
  
</style>

<!-- JavaScript for Data Fetching and Gallery Logic -->
<script define:vars={{ propertyData, docIcon,openInNewWindow }}>
const BATHROOM_SVG = `<svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="currentColor"><path d="M280-600q-33 0-56.5-23.5T200-680q0-33 23.5-56.5T280-760q33 0 56.5 23.5T360-680q0 33-23.5 56.5T280-600ZM200-80q-17 0-28.5-11.5T160-120q-33 0-56.5-23.5T80-200v-240h120v-30q0-38 26-64t64-26q20 0 37 8t31 22l56 62q8 8 15.5 15t16.5 13h274v-326q0-14-10-24t-24-10q-6 0-11.5 2.5T664-790l-50 50q5 17 2 33.5T604-676L494-788q14-9 30-11.5t32 3.5l50-50q16-16 36.5-25t43.5-9q48 0 81 33t33 81v326h80v240q0 33-23.5 56.5T800-120q0 17-11.5 28.5T760-80H200Zm-40-120h640v-160H160v160Zm0 0h640-640Z"/></svg>`;

// FIX 2: Standardize width, height, and use currentColor for CSS control
const SQM_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="30px" height="30px" fill="currentColor" viewBox="0 -3 16 16"><path d="M7.44 11.28a.48.48 0 0 1-.48.48H5.04a.48.48 0 0 1 0-.96h1.92a.48.48 0 0 1 .48.48ZM.72 7.44a.48.48 0 0 0 .48-.48V5.04a.48.48 0 1 0-.96 0v1.92c0 .265.215.48.48.48Zm1.92 3.36H1.2V9.36a.48.48 0 1 0-.96 0v1.44c0 .53.43.96.96.96h1.44a.48.48 0 1 0 0-.96Zm9.12-9.6a.96.96 0 0 0-.96-.96H1.2a.952.952 0 0 0-.713.32.952.952 0 0 0-.247.64v1.44a.48.48 0 0 0 .96 0v-.761l8.922 8.921H9.36a.48.48 0 1 0 0 .96h1.44a.955.955 0 0 0 .714-.32.952.952 0 0 0 .246-.64V1.2Z"/></svg>`;

// FIX 3: Placeholder for Room SVG - REMOVE DATA-IMAGE and use simple path/viewBox
const ROOM_SVG = `<svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="currentColor"><path d="M120-120v-80h80v-560q0-33 23.5-56.5T280-840h400q33 0 56.5 23.5T760-760v560h80v80H120Zm560-80v-560H280v560h400ZM560-440q17 0 28.5-11.5T600-480q0-17-11.5-28.5T560-520q-17 0-28.5 11.5T520-480q0 17 11.5 28.5T560-440ZM280-760v560-560Z"/></svg>`;
const CALENDAR_SVG = `<svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="currentColor"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Zm280 240q-17 0-28.5-11.5T440-440q0-17 11.5-28.5T480-480q17 0 28.5 11.5T520-440q0 17-11.5 28.5T480-400Zm-160 0q-17 0-28.5-11.5T280-440q0-17 11.5-28.5T320-480q17 0 28.5 11.5T360-440q0 17-11.5 28.5T320-400Zm320 0q-17 0-28.5-11.5T600-440q0-17 11.5-28.5T640-480q17 0 28.5 11.5T680-440q0 17-11.5 28.5T640-400ZM480-240q-17 0-28.5-11.5T440-280q0-17 11.5-28.5T480-320q17 0 28.5 11.5T520-280q0 17-11.5 28.5T480-240Zm-160 0q-17 0-28.5-11.5T280-280q0-17 11.5-28.5T320-320q17 0 28.5 11.5T360-280q0 17-11.5 28.5T320-240Zm320 0q-17 0-28.5-11.5T600-280q0-17 11.5-28.5T640-320q17 0 28.5 11.5T680-280q0 17-11.5 28.5T640-240Z"/></svg>`;


// --- Global State for Gallery ---
let allPhotos = [];
let currentImageIndex = 0;

// Utility functions
const formatCurrency = (amount) => {
  if (amount === null || amount === undefined) return "Auf Anfrage";
  return new Intl.NumberFormat("de-DE", {
    style: "currency",
    currency: "EUR",
    maximumFractionDigits: 0,
  }).format(amount);
};
const createFactItem = (value, label, icon) => {

  const factItemStyle = `
   
    border-radius: var(--border-radius);
    `
  const factItemWrapperStyle = `
    display:flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-sm);
    padding-bottom: var(--spacing-sm);
    `
  const iconDivStyle = `
    align-items: center;
    `
  const factItemValueStyle = `
  font-size: var(--font-size-h5);
    font-weight: var(--font-weight-bold);
    color: var(--color-neutral-font-dark);
    
    `

  if (!value || value === "null" || value === false) return "";
  return `<div class="fact-item" style="${factItemStyle}"><div class="fact-item-wrapper" style="${factItemWrapperStyle}"><div class="text-xl font-bold main-fact-icon" style="${iconDivStyle}">${icon}</div><p class="fact-item-value" style="${factItemValueStyle}">${value === true ? "Ja" : value}</p></div><p class="fact-item-label">${label}</p></div>`;
};


//for Objektdetails card
const createDetailItem = (value, label) => {
  if (!value || value === "null") return "";
  const titleStyle = "text-align:left"
  const boldStyle = "font-weight: 700; text-align:left; word-break: normal;";
  return `<dt class="fact-title" style="${titleStyle}">${label}</dt><dd class="fact-data" style="${boldStyle}">${value}</dd>`;
};

const renderPortableText = (blocks) => {
  if (!blocks || blocks.length === 0) return "";

  let html = "";
  let inList = false; // Flag to track if we are currently inside an <ul> block

  const listStyle = "list-style: disc; padding-left: 1.5em; margin-bottom: 1em;";
  blocks.forEach((block) => {
    // 1. Process block children (spans) for content and marks (like bold)
    const content = block.children
      .map((span) => {
        let text = span.text;
        // Apply marks like 'strong'
        if (span.marks && span.marks.includes("strong")) {
          text = `<strong>${text}</strong>`;
        }
        return text;
      })
      .join("");

    // --- LOGIC FOR LISTS AND PARAGRAPHS ---

    if (block.listItem === "bullet") {
      // START LIST: If we are not currently in a list, start one.
      if (!inList) {
        html += `<ul style="${listStyle}">`; inList = true;
      }
      // Add the list item content
      html += `<li>${content}</li>`;

    } else {
      // END LIST: If we were in a list and this block is NOT a list item, close the list.
      if (inList) {
        html += "</ul>";
        inList = false;
      }
      // Handle non-list blocks as simple paragraphs
      html += `<p>${content}</p>`;
    }
  });

  // FINAL STEP: If the document ends while still inside a list, close it.
  if (inList) {
    html += "</ul>";
  }

  return html;
};
/**
 * Updates the main image and highlights the active thumbnail.
 */
// --- Utility function for Image Optimization ---
const getOptimizedUrl = (originalUrl, width, quality = 80) => {
  if (!originalUrl) return originalUrl;
  // Use Sanity's URL parameters for resizing, quality, and format
  return `${originalUrl}?w=${width}&q=${quality}&fit=max&fm=webp`;
};
// ---------------------------------------------

const showImage = (index) => {
  if (allPhotos.length === 0) return;

  // Circular array logic
  currentImageIndex = (index + allPhotos.length) % allPhotos.length;
  const photo = allPhotos[currentImageIndex];

  const mainImgElement = document.getElementById("main-gallery-image");
  const modalImgElement = document.getElementById("modal-image");
  const thumbnails = document.querySelectorAll(".thumbnail-image");

  // 1. Update main image (with smooth transition)
  mainImgElement.style.opacity = 0;
  setTimeout(() => {
    mainImgElement.src = getOptimizedUrl(photo.url, 1400, 85);
    mainImgElement.alt =
      photo.alt || `Immobilienfoto ${currentImageIndex + 1}`;
    mainImgElement.style.opacity = 1;
  }, 200);

  // 2. Update modal image immediately if modal is open
  if (
    document
      .getElementById("fullscreen-gallery-modal")
      .classList.contains("active")
  ) {
    modalImgElement.src = getOptimizedUrl(photo.url, 2000, 85);
    modalImgElement.alt =
      photo.alt || `Vollbildansicht ${currentImageIndex + 1}`;
  }

  // 3. Update active thumbnail highlight and scroll
  thumbnails.forEach((thumb, i) => {
    if (i === currentImageIndex) {
      thumb.classList.add("active");
      thumb.scrollIntoView({
        behavior: "smooth",
        inline: "center",
        block: "nearest",
      });
    } else {
      thumb.classList.remove("active");
    }
  });
};

const nextImage = () => showImage(currentImageIndex + 1);
const prevImage = () => showImage(currentImageIndex - 1);

const openModal = () => {
  const modal = document.getElementById("fullscreen-gallery-modal");
  const modalImgElement = document.getElementById("modal-image");

  // Set the initial image in the modal
  const currentPhoto = allPhotos[currentImageIndex];
  if (currentPhoto) {
    modalImgElement.src = currentPhoto.url;
  }

  modal.classList.add("active");
  document.body.style.overflow = "hidden"; // Prevent scrolling the main page
};

const closeModal = () => {
  const modal = document.getElementById("fullscreen-gallery-modal");
  modal.classList.remove("active");
  document.body.style.overflow = ""; // Restore scrolling
};

// --- MAIN RENDER FUNCTION ---
const renderProperty = (data) => {
  const skeletonElement = document.getElementById('loading-skeleton');
  document.getElementById("property-listing-content").style.display = "block";

  if (skeletonElement) {
    skeletonElement.style.display = 'none';
  }

  // 1. HEADER & PRICE
  document.getElementById("listing-title").textContent = data.title;


  let locationText = "Unbekannte Lage";
  if (data.locationVienna) {
    locationText = `Wien, ${data.locationVienna}`;
  } else if (data.locationPostcode) {
    locationText = `Lage Umgebung, ${data.locationPostcode}`;
  }

  document.getElementById("listing-address").textContent = `${locationText} `;

  const price = data.rentalPrice;
  const priceText = price
    ? formatCurrency(price) + " / Monat"
    : "Preis auf Anfrage";
  document.getElementById("listing-price").textContent = priceText;
  document.getElementById("listing-type").textContent =
    `${data.propertyType} ${data.marketingType}`;

  // 2. IMAGE GALLERY SETUP

  // Combine mainImage and photos for the gallery
  allPhotos = [
    // 1. Check for the single main image named 'mainImage'
    ...(data.mainImage && data.mainImage.url
      ? [{ url: data.mainImage.url, alt: data.title + " Hauptbild" }]
      : []),
    // 2. Add all images from the 'photos' array
    // We ensure each item exists and has a resolved 'url' before mapping
    ...(data.photos || [])
      .filter((photo) => photo && photo.url)
      .map((photo) => ({ url: photo.url, alt: photo.alt || "Zusatzfoto" })),
  ];

  const thumbnailsContainer = document.getElementById("gallery-thumbnails");
  thumbnailsContainer.innerHTML = allPhotos
    .map(
      (photo, index) => `
                <img 
                src="${getOptimizedUrl(photo.url, 250, 70)}"
                    alt="${photo.alt || "Immobilienfoto " + (index + 1)}" 
                    class="thumbnail-image"
                    data-index="${index}"
                    loading="lazy"
                >
            `
    )
    .join("");

  // Initialize the first image
  if (allPhotos.length > 0) {
    showImage(currentImageIndex);
  } else {
    // Fallback if no images are found
    document.getElementById("main-gallery-image").src =
      "https://placehold.co/1200x800/e5e7eb/6b7280?text=Keine+Bilder+verfügbar";
  }

  // Add click listener to thumbnails
  thumbnailsContainer.querySelectorAll("img").forEach((thumb) => {
    thumb.addEventListener("click", (e) => {
      const index = parseInt(e.target.dataset.index);
      showImage(index);
    });
  });

  // Add click listeners for main gallery navigation
  document.getElementById("next-button").addEventListener("click", (e) => {
    e.preventDefault(); // Stop image from jumping up
    e.currentTarget.blur();
    nextImage();
  });
  document.getElementById("prev-button").addEventListener("click", (e) => {
    e.preventDefault(); // Stop image from jumping up
    e.currentTarget.blur();
    prevImage();
  });

  // Add click listener for fullscreen toggle
  document
    .getElementById("fullscreen-toggle")
    .addEventListener("click", openModal);

  // Add modal listeners
  document
    .getElementById("modal-close")
    .addEventListener("click", closeModal);
  document.getElementById("modal-next").addEventListener("click", nextImage);
  document.getElementById("modal-prev").addEventListener("click", prevImage);

  // Add keyboard navigation for the modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeModal();
    } else if (
      document
        .getElementById("fullscreen-gallery-modal")
        .classList.contains("active")
    ) {
      if (e.key === "ArrowRight") nextImage();
      if (e.key === "ArrowLeft") prevImage();
    }
  });

  // 3. KEY FACTS
  const keyFactsHTML = [
    createFactItem(
      data.livingArea ? `${data.livingArea} m²` : null,
      "Wohnfläche",
      SQM_SVG
    ),
    createFactItem(data.rooms, "Zimmer", ROOM_SVG),
    createFactItem(data.bathrooms, "Badezimmer", BATHROOM_SVG),
    createFactItem(`Ab ${data.availableDate}`, "Verfügbar", CALENDAR_SVG),
  ].join("");
  document.getElementById("key-facts").innerHTML = keyFactsHTML;

  // 4. DESCRIPTION & AMENITIES
  // document.getElementById("property-description").textContent =
  //   data.description ? data.description.trim() : "";
  const descriptionElement = document.getElementById("property-description");

  if (data.propertyDescription && descriptionElement) {
    descriptionElement.textContent = data.propertyDescription.trim();
  } else if (descriptionElement) {
    // Show a fallback message if data is empty
    descriptionElement.textContent = "Keine Objektbeschreibung verfügbar.";
  }

  const ausstattungDetailsHTML = renderPortableText(data.ausstattungDetails);
  document.getElementById("ausstattung-details").innerHTML =
    ausstattungDetailsHTML;

  const complexFeaturesContainer =
    document.getElementById("complex-features");
  if (data.complexFeatures && data.complexFeatures.length > 0) {
    complexFeaturesContainer.innerHTML = data.complexFeatures
      .map((feature) => `<span class="feature-tag">${feature}</span>`)
      .join("");
  }

  // 5. LOCATION DESCRIPTION
  document.getElementById("location-description").textContent =
    data.locationDescription ? data.locationDescription.trim() : "";


  // 7. AGENT CARD
  const agentImageElement = document.getElementById("agent-image");
  document.getElementById("agent-name").textContent = data.agent?.name;
  document.getElementById("agent-phone").textContent = data.agent?.phone;
  document.getElementById("agent-email").href = `mailto:${data.agent?.email}`;
  document.getElementById("agent-email").textContent = data.agent?.email || 'E-Mail senden';
  const agentImageUrl = data.agent?.agentImage?.url;
  if (agentImageUrl) {
    if (typeof agentImageUrl === 'string') {
      agentImageElement.src = getOptimizedUrl(agentImageUrl, 150, 80);
      // ... rest of the code
    } else {
      // Log the object structure for debugging if it's not a string
      console.error("Agent Image URL is not a string:", agentImageUrl);
    }
    if (typeof agentImageUrl === 'string' && agentImageUrl) {
      // Pass the valid string URL to your optimizer function
      agentImageElement.src = getOptimizedUrl(agentImageUrl, 150, 80);
      agentImageElement.alt = `Maklerbild von ${data.agent?.name || 'dem Ansprechpartner'}`;
      agentImageElement.style.display = 'block';
    } else {
      // This branch handles cases where the URL is missing or not a string
      console.error("Agent image URL not found or not a string:", agentImageUrl);
      agentImageElement.src = "https://placehold.co/100x100/e5e7eb/6b7280?text=M";
      agentImageElement.alt = "Maklerbild Platzhalter";
      agentImageElement.style.display = 'block';
    }
  }

  // 8. DETAILS & DOWNLOADS FACT BOX
  const factBoxList = document.getElementById("fact-box-list");
  //  Conditional price determination
  let priceItemHTML = "";
  let priceTitle = "";
  let priceValue = null;

  if (data.marketingType === "Miete") {
    priceTitle = "Mietpreis (gesamt)";
    // Assuming rentalPrice is the field name for rent
    priceValue = data.rentalPrice ? `${data.rentalPrice} €` : null;
  } else if (data.marketingType === "Kauf") {
    priceTitle = "Kaufpreis";
    // Assuming purchasePrice is the field name for purchase price
    priceValue = data.purchasePrice ? `${data.purchasePrice} €` : null;
  }

  if (priceValue) {
    priceItemHTML = createDetailItem(priceValue, priceTitle);
  }
  const factBoxHTML = [
    // BASIC INFO
    createDetailItem(data.propertyType, "Objektart"),
    createDetailItem(data.marketingType, "Vermarktungsart"),



    // AREA & ROOMS
    createDetailItem(data.rooms, "Zimmeranzahl"),
    createDetailItem(data.bathrooms, "Badezimmer"),
    createDetailItem(data.livingArea ? `${data.livingArea} m²` : null, "Wohnfläche"),
    createDetailItem(data.useableArea ? `${data.useableArea} m²` : null, "Nutzfläche"),

    // COSTS (if applicable)
    priceItemHTML,
    createDetailItem(data.provision, "Provision"),
    createDetailItem(data.betriebskosten ? `${data.betriebskosten} €` : null, "Betriebskosten"),
    createDetailItem(data.heizkosten ? `${data.heizkosten} €` : null, "Heizkosten"),

    // MISC
    createDetailItem(data.parking, "Stellplätze"),
    createDetailItem(data.hwb ? `${data.hwb} kWh/m²` : null, "HWB (Heizwärmebedarf)"),
    createDetailItem(data.energyCertificate, "Energieausweis"),

  ].join("");
  factBoxList.innerHTML = factBoxHTML;
};

// 9. DOWNLOAD LINK FOR FLOOR PLAN
const factBox = document.querySelector(".fact-box"); // Select the fact box element

// Assuming propertyData is the parsed object containing floorPlanUrl
// You need to extract the floorPlan URL from the propertyData object
const floorPlanUrl = propertyData.floorPlan || null;

if (floorPlanUrl && factBox) {
  // Define the base inline style for the download link container
  const downloadLinkInlineStyle = `
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    width: 100%; 
    padding: var(--spacing-md); 
    margin-top: var(--spacing-xl); 
    border-radius: var(--border-radius); 
    background-color: var(--color-brand-light-green); 
    color: var(--color-neutral-font-dark); 
    text-decoration: none; 
    transition: background-color 0.2s ease;
`;


  const downloadLeftWrapper = `
display: flex;
align-items: center;
gap: var(--spacing-md);
`
  const iconInlineStyle = `
    width: 18px; 
    height: 18px;
     flex-shrink: 0;
`;

  const downloadLinkHTML = `
        <a href="${floorPlanUrl}" 
           class="download-link" 
           target="_blank" 
           download 
           aria-label="Grundriss herunterladen"
           style="${downloadLinkInlineStyle}">
            
           <div style="${downloadLeftWrapper}">
            <img
                src="${docIcon.src}" 
                alt="Dokumente Icon" 
                class="document-icon" 
                style="${iconInlineStyle}" 
            />
            
            Grundriss herunterladen
            </div>
            <img
                        src="${openInNewWindow.src}"
                        alt="icon für in neuem fenster öffnen"
                        class="document-icon"
                        style="${iconInlineStyle}" 

                      />
        </a>
    `;
  factBox.insertAdjacentHTML('beforeend', downloadLinkHTML);
}

// --- FETCH LOGIC ---
window.onload = function () {
  console.log("property description", propertyData.propertyDescription);
  renderProperty(propertyData);
  window.scrollTo(0, 0);
};
</script>
../../Base/AgentContactForm.tsx