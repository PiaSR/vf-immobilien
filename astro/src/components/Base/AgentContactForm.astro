---
import Button from "./Button.astro";
interface Props {
  property?: { id: string; title: string } | null;
}
const { property = null } = Astro.props as Props;
---

<form
  id="agent-contact-form"
  name="agent-contact-form"
  data-name="agent contact form"
  method="POST"
  action="/api/contactFormSend"
  novalidate
>
  <input type="hidden" name="property-id" value={property?.id ?? ""} />
  <input type="hidden" name="property-title" value={property?.title ?? ""} />
  <input
    type="hidden"
    name="property-address"
    value={property?.address ?? ""}
  />

  <div class="form-field-group">
    <label for="agent-first-name" class="visually-hidden">Ihr Name</label>
    <input
      class="form-input"
      maxlength="256"
      name="first-name"
      placeholder="Ihr Name"
      type="text"
      id="agent-first-name"
      required
    />
    <span id="error-agent-first-name" class="input-error-message"></span>
  </div>

  <div class="form-field-group">
    <label for="agent-email" class="visually-hidden">Ihre Email</label>
    <input
      class="form-input"
      maxlength="256"
      name="email"
      placeholder="Ihre Email"
      type="email"
      id="agent-email-input"
      required
    />
    <span id="error-agent-email" class="input-error-message"></span>
  </div>

  <div class="form-field-group">
    <label for="agent-phone" class="visually-hidden">Telefonnummer</label>
    <input
      class="form-input"
      maxlength="256"
      name="phone"
      placeholder="Ihre Telefonnummer"
      type="tel"
      id="agent-phone-input"
      required
    />
    <span id="error-agent-phone" class="input-error-message"></span>
  </div>

  <div class="form-field-group">
    <label for="agent-message" class="visually-hidden">Ihre Nachricht</label>
    <textarea
      id="agent-message"
      name="message"
      maxlength="5000"
      placeholder="Ich interessiere mich für dieses Objekt..."
      class="form-textarea"
      required>Ich interessiere mich für dieses Objekt.</textarea
    >
    <span id="error-agent-message" class="input-error-message"></span>
  </div>

  <label class="form-checkbox-label">
    <input
      type="checkbox"
      name="TandCs"
      id="agent-TandCs"
      data-name="TandCs"
      required
    />
    <span class="checkbox-custom-indicator"></span>
    <span class="checkbox-text" for="agent-TandCs"
      >Ich habe die <a href="/agb">AGB</a> und <a href="/datenschutz"
        >Daten&shy;schutz&shy;be&shy;stimmungen</a
      > gelesen und erkläre mich damit ein&shy;ver&shy;standen.</span
    >
  </label>
  <div class="checkbox-error-wrapper">
    <span id="error-agent-TandCs" class="input-error-message"></span>
  </div>

  <div class="padding-bottom padding-small"></div>

  <Button type="submit" class="button-green button-small">
    Anfrage senden
  </Button>

  <div id="agent-form-success" class="form-success-message">
    <div>Danke für Ihre Anfrage! Wir werden uns bald bei Ihnen melden.</div>
  </div>
  <div id="agent-form-error" class="form-error-message">
    <div>
      Beim Absenden des Formulars ist ein Fehler aufgetreten. Bitte versuchen
      Sie es erneut.
    </div>
  </div>
</form>

<style>
  /* --- Style Block (Unchanged) --- */

  /* NEU: Styling für Fehlermeldungen */
  .input-error-message {
    font-size: 0.8rem;
    color: var(--color-system-error);
    margin-top: 0.25rem;
    display: none; /* Wichtig: Standardmäßig ausblenden */
    font-weight: 500;
  }

  /* NEU: Styling für fehlerhafte Eingaben */
  .form-input.error,
  .form-textarea.error {
    border-color: var(--color-system-error);
  }

  /* --- Existing Styles --- */
  .contact-section {
    position: relative;
    padding: var(--spacing-4xl) 0;
    background-color: var(--color-neutral-lightest);
    z-index: 5;
    padding-bottom: calc(var(--spacing-4xl) + 15vw);
  }

  .contact-card-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 700px;
  }
  .site-container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding-left: var(--spacing-md);
    padding-right: var(--spacing-md);
  }
  .padding-section {
    padding-top: var(--spacing-3xl);
    padding-bottom: var(--spacing-3xl);
  }
  .section-header-wrapper {
    text-align: start;
    word-wrap: break-word;
  }

  .heading-h2 {
    color: var(--color-brand-medium-green);
    margin-bottom: var(--spacing-md);
    font-size: 2.5rem;
  }

  .text-description {
    font-size: var(--font-size-body-base);
    color: var(--color-neutral-dark);
  }

  .contact-form-container {
    padding-top: var(--spacing-3xl);
    color: var(--color-neutral-font-dark);
  }

  .form-field-group {
    display: flex;
    flex-direction: column;
    margin-bottom: var(--spacing-lg);
    width: 100%;
  }

  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important; /* Fixes issues with some screen readers */
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important; /* Prevents text wrapping */
    border: 0 !important;
  }

  label {
    font-weight: var(--font-weight-bold);
    margin-bottom: 0.5rem;
    display: block;
    color: var(--color-neutral-font-dark);
  }

  .form-input,
  .form-textarea {
    width: 100%;
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--color-neutral-medium-grey);
    border-radius: var(--border-radius);
    font-size: var(--font-size-body);
    transition: border-color 0.3s ease;
    font-family: var(--font-primary);
  }

  .form-input:focus,
  .form-textarea:focus {
    border-color: var(--color-neutral-font-dark);
    outline: none;
  }

  .form-textarea {
    min-height: 80px;
    resize: vertical;
  }

  .form-checkbox-label {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    font-size: var(--font-size-body-small);
    color: var(--color-neutral-dark);
    margin-bottom: var(--spacing-md);
  }

  .form-checkbox-label input[type="checkbox"] {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
  }

  .checkbox-custom-indicator {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-brand-medium-green);
    border-radius: 4px;
    margin-right: var(--spacing-sm);
    flex-shrink: 0;
    position: relative;
    top: 2px;
    transition:
      background-color 0.2s ease,
      border-color 0.2s ease;
  }

  .checkbox-custom-indicator::after {
    content: "";
    position: absolute;
    top: 2px;
    left: 5px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    display: none;
  }

  .form-checkbox-label
    input[type="checkbox"]:checked
    + .checkbox-custom-indicator {
    background-color: var(--color-brand-medium-green);
    border-color: var(--color-brand-medium-green);
  }

  .form-checkbox-label
    input[type="checkbox"]:checked
    + .checkbox-custom-indicator::after {
    display: block;
  }

  .checkbox-text {
    line-height: 1.4;
    font-size: var(--font-size-body-xsmall);
    font-weight: var(--font-weight-regular);
    text-align: left;
  }
  .checkbox-text > a {
    text-decoration: underline;
  }

  .padding-bottom {
    padding-bottom: 1rem;
  }
  .padding-small {
    padding-bottom: 0.5rem;
  }
  .padding-medium {
    padding-bottom: 1rem;
  }

  .form-success-message,
  .form-error-message {
    padding: var(--spacing-md);
    margin-top: var(--spacing-lg);
    border-radius: var(--border-radius);
    font-weight: var(--font-weight-bold);
    text-align: center;
    display: none;
  }

  .button-green {
    width: 100%;
  }
  .form-success-message {
    background-color: var(--color-system-success);
    color: var(--color-system-success-font);
  }

  .form-error-message {
    background-color: var(--color-system-error);
    color: var(--color-system-error-font);
  }
  .form-success-message.is-visible {
    display: block !important; /* Force visibility */
    opacity: 1; /* Ensure visibility if transitions/opacity were involved */
  }
</style>
<script>
  (function () {
    // --- Configuration ---
    const AGENT_FORM_ID = "agent-contact-form";
    const AGENT_SUCCESS_ID = "agent-form-success";
    const AGENT_ERROR_ID = "agent-form-error";

    // Zuordnung der Feldnamen zu deutschen Fehlermeldungen (re-defined locally)
    const ERROR_MESSAGES = {
      "first-name": "Ihr Name ist erforderlich.",
      "last-name": "Nachname ist erforderlich.",
      email: {
        required: "E-Mail-Adresse ist erforderlich.",
        invalid:
          "Bitte geben Sie eine gültige E-Mail-Adresse ein (z.B. name@domain.at).",
      },
      phone: {
        required: "Telefonnummer ist erforderlich.",
        invalid:
          "Die Telefonnummer darf nur Ziffern und übliche Zeichen (+, -, Klammern) enthalten.",
      },
      message: "Eine Nachricht ist erforderlich.",
      TandCs: "Sie müssen den AGBs und Datenschutzbestimmungen zustimmen.",
    };

    // --- Element Getters ---
    const formEl = document.getElementById(AGENT_FORM_ID);
    const successMessage = document.getElementById(AGENT_SUCCESS_ID);
    const errorMessage = document.getElementById(AGENT_ERROR_ID);

    if (!formEl) return; // Exit if component is loaded outside of expected context

    // Function to get the correct error element based on field name
    function getErrorElement(fieldName) {
      if (fieldName === "TandCs") {
        return document.getElementById(`error-agent-${fieldName}`);
      }
      const element = document.getElementById(`error-agent-${fieldName}`);

      if (!element) {
        return formEl.querySelector(`#error-${fieldName}`);
      }
      return element;
    }

    // Funktion zum Zurücksetzen aller Fehler
    function clearErrors() {
      successMessage.classList.remove("is-visible");
      errorMessage.classList.remove("is-visible");

      formEl.querySelectorAll(".input-error-message").forEach((el) => {
        el.textContent = "";
        el.style.display = "none";
      });

      formEl.querySelectorAll(".form-input, .form-textarea").forEach((el) => {
        el.classList.remove("error");
      });
    }

    // Funktion zur Anzeige der Erfolgs-/Fehlermeldungen (für Server-Antwort)
    function showMessage(isSuccess, errorDetail = null) {
      clearErrors();
      const element = isSuccess ? successMessage : errorMessage;

      if (element) {
        element.classList.add("is-visible");

        if (!isSuccess && errorDetail) {
          const errorDiv = element.querySelector("div");
          errorDiv.innerHTML = `
			Beim Absenden des Formulars ist ein Fehler aufgetreten. Bitte
			versuchen Sie es erneut.
			<br><br>
			<strong>Fehler-Details:</strong> ${errorDetail}
		  `;
        } else if (!isSuccess) {
          element.querySelector("div").textContent =
            `Beim Absenden des Formulars ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.`;
        }
      }
    }

    // Helper-Funktion zur Validierung des E-Mail-Formats
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // Helper-Funktion zur Validierung der Telefonnummer
    function isValidPhone(phone) {
      const phoneRegex = /^[0-9\s\-\+\(\)]+$/;
      return phoneRegex.test(phone);
    }

    // NEUE Funktion zur Client-Side-Validierung
    function validateForm() {
      clearErrors();
      let isValid = true;
      let firstInvalidField = null;

      formEl.querySelectorAll("[required]").forEach((field) => {
        const fieldName = field.name;
        const errorElement = getErrorElement(fieldName);
        const fieldValue = field.value.trim();
        let hasError = false;
        let errorMessageKey = "required";

        if (field.type === "checkbox") {
          if (!field.checked) {
            hasError = true;
          }
        } else if (fieldValue === "") {
          hasError = true;
        }

        if (!hasError && fieldValue !== "") {
          if (fieldName === "email" && !isValidEmail(fieldValue)) {
            hasError = true;
            errorMessageKey = "invalid";
          } else if (fieldName === "phone" && !isValidPhone(fieldValue)) {
            hasError = true;
            errorMessageKey = "invalid";
          }
        }

        if (hasError) {
          isValid = false;

          if (errorElement) {
            let message;
            if (typeof ERROR_MESSAGES[fieldName] === "object") {
              message = ERROR_MESSAGES[fieldName][errorMessageKey];
            } else {
              message = ERROR_MESSAGES[fieldName];
            }

            errorElement.textContent = message;
            errorElement.style.display = "block";
          }

          if (field.type !== "checkbox") {
            field.classList.add("error");
          }

          if (!firstInvalidField) {
            firstInvalidField = field;
          }
        } else {
          if (field.type !== "checkbox") {
            field.classList.remove("error");
          }
          if (errorElement) {
            errorElement.style.display = "none";
          }
        }
      });

      if (!isValid && firstInvalidField) {
        firstInvalidField.focus();
        firstInvalidField.scrollIntoView({
          behavior: "smooth",
          block: "center",
        });
      }

      return isValid;
      // Removed: alert(isValid); (This line was unreachable anyway)
    }

    // Funktion, um Fehler bei der Eingabe sofort zu entfernen
    function handleInput(event) {
      const field = event.target;

      if (field.type === "checkbox") {
        validateForm();
        return;
      }

      if (field.value.trim() !== "") {
        field.classList.remove("error");
        const errorElement = getErrorElement(field.name);
        if (errorElement) {
          errorElement.style.display = "none";
        }
      } else if (field.hasAttribute("required")) {
        validateForm();
      }
    }

    // Listener für sofortige Validierung/Feedback beim Tippen/Klicken
    formEl.querySelectorAll("[required]").forEach((field) => {
      field.addEventListener("input", handleInput);
    });
    document
      .getElementById("agent-TandCs")
      ?.addEventListener("change", handleInput);

    // Handle form submission using AJAX (Fetch API)
    // FIX 1: Changed comma to parenthesis here
    formEl.addEventListener("submit", async function (event) {
      event.preventDefault();

      if (!validateForm()) {
        return;
      }

      const button = formEl.querySelector("button[type='submit']");
      const originalButtonText = button.textContent;
      button.textContent = "Anfrge senden...";
      button.disabled = true;

      const data = new FormData(event.target);
      const formUrl = event.target.action;

      // Add context to differentiate this form on the server (vs. generic contact form)
      data.append("context", "Sidebar Agent Card");

      const urlEncodedData = new URLSearchParams(data);

      try {
        const response = await fetch(formUrl, {
          method: "POST",
          body: urlEncodedData.toString(),
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        });

        // --- SERVER RESPONSE HANDLING ---

        if (response.ok) {
          try {
            // Attempt to read the JSON body (to consume the stream)
            await response.json();
          } catch (e) {
            console.log("Response body was not valid JSON but status was OK.");
          }

          // Success sequence
          //   formEl.style.display = "none"; // Hide the form element
          showMessage(true); // Display the success message
          formEl.reset(); // Formularfelder leeren
        } else {
          // Error sequence (Status is 4xx or 5xx)
          let errorDetail = `Status ${response.status}`;
          const contentType = response.headers.get("content-type");

          if (response.status === 404) {
            errorDetail = `404: API-Endpunkt unter ${formUrl} nicht gefunden.`;
          } else if (contentType && contentType.includes("application/json")) {
            const errorBody = await response.json();
            errorDetail =
              errorBody.error || `Serverfehler (Status: ${response.status})`;
          } else {
            errorDetail = `Unbekannte Antwort (HTML/Text). Status: ${response.status}`;
          }

          console.error(
            "Formularübermittlung fehlgeschlagen:",
            response.status,
            errorDetail
          );
          showMessage(false, errorDetail);
          formEl.style.display = "block";
        }
        // --- END SERVER RESPONSE HANDLING ---
      } catch (error) {
        console.error("Netzwerkfehler beim Absenden des Formulars:", error);
        showMessage(false, `Netzwerkfehler: ${error.message}`);
        formEl.style.display = "block";
      } finally {
        if (formEl.style.display !== "none") {
          button.textContent = originalButtonText;
          button.disabled = false;
        }
      }
    });
  })();
</script>
