---
import { sanityClient } from "../../lib/sanityClient";
import MainLayout from "../../layouts/MainLayout.astro";
import PropertyListingDetails from "../../components/Sections/properties/PropertyListingDetails.astro";
export const prerender = true;

//  REQUIRED FUNCTION: getStaticPaths
export async function getStaticPaths() {
  // GROQ query to fetch all property slugs
  const allSlugsQuery = `*[_type == "property" && defined(slug.current)]{ "slug": slug.current }`;

  const slugs = await sanityClient.fetch(allSlugsQuery);

  // Map the slugs into the format Astro expects: [{ params: { slug: '...' } }]
  return slugs.map((property) => ({
    params: { slug: property.slug },
  }));
}

// 4. GET THE CURRENT SLUG & FETCH DATA
const { slug } = Astro.params;

// comprehensive GROQ query
const detailedPropertyQuery = `
  *[
    _type == "property" 
    && slug.current == $slug
  ][0] { 
   
    "id": _id,
    title, 
    name, 
    slug,
    propertyType,
    "marketingType": marketingType->title, // Dereference category for title
    available,
    availableDate,
   
    
    address,
    locationVienna,
    locationSurrounding,
    postalCodeSurrounding,
    suburb, 
    
    // Property Details
    purchasePrice,
    rentalPrice,
    livingArea,
    useableArea, 
    rooms,
    bathrooms,
    yearBuilt,
    floor,
    betriebskosten, 
    heizkosten,     
    provision,      
    hwb,            
    gee,            
    energyCertificate, 
    outdoorArea,    
    isFullyFurnished, 
    
    "ausstattung": ausstattung[]->title, 
    propertyDescription,
    locationDescription,
    ausstattungDetails, 
    
    "mainImage": mainImage.asset->{url, metadata}, 
    "photos": photos[] {
        _key,
       
        "url": asset->url, 
        "dimensions": asset->metadata.dimensions 
    },
    "floorPlan": floorPlan.asset->{url, metadata}, 
    
    
    agent->{ 
      name,
      phone,
      email,
      "agentImage": agentImage.asset->{url, metadata}
    }
  }
`;
const propertyData = await sanityClient.fetch(detailedPropertyQuery, { slug });

// Handle case where property is not found
if (!propertyData) {
  // Note: Astro.redirect only works in SSR mode, but this is best practice.
  // In SSG mode (default), Astro will usually show a static 404 if the path wasn't generated.
  return Astro.redirect("/404");
}
// ----------------------------------------------------
// ✨ MAP LOGIC START (FIXED)
// ----------------------------------------------------

// 1. Helper map for Vienna District to Postal Code (remains unchanged, used for centering)
const viennaDistrictMap = {
  // Use the district number as the key
  "1.": "1010 Wien",
  "2.": "1020 Wien",
  "3.": "1030 Wien",
  "4.": "1040 Wien",
  "5.": "1050 Wien",
  "6.": "1060 Wien",
  "7.": "1070 Wien",
  "8.": "1080 Wien",
  "9.": "1090 Wien",
  "10.": "1100 Wien",
  "11.": "1110 Wien",
  "12.": "1120 Wien",
  "13.": "1130 Wien",
  "14.": "1140 Wien",
  "15.": "1150 Wien",
  "16.": "1160 Wien",
  "17.": "1170 Wien",
  "18.": "1180 Wien",
  "19.": "1190 Wien",
  "20.": "1200 Wien",
  "21.": "1210 Wien",
  "22.": "1220 Wien",
  "23.": "1230 Wien",
};

let mapSearchQuery = ""; // This variable holds the string Google Maps searches for (and displays)
let mapZoom = 14;

if (propertyData.suburb && propertyData.locationVienna) {
  // PRIORITY 1: Suburb
  // Example: "Spittelberg"
  mapSearchQuery = `${propertyData.suburb}`;
  mapZoom = 15;
} else if (
  propertyData.locationSurrounding &&
  propertyData.postalCodeSurrounding
) {
  // PRIORITY 2: Wien Umgebung + PLZ
  // Example: "Hinterbrühl" + postal code
  const postal = propertyData.postalCodeSurrounding
    ? `${propertyData.postalCodeSurrounding} `
    : "";
  mapSearchQuery = `${propertyData.locationSurrounding}${postal}`;
  mapZoom = 14;
} else if (propertyData.locationVienna) {
  // FALLBACK 3: Vienna District (Original robust fallback)
  // We use the Postal Code for robust centering, and Google will label it with the district.
  const districtKeyMatch = propertyData.locationVienna.match(/^\d+\./);
  const districtKey = districtKeyMatch ? districtKeyMatch[0] : null;

  if (districtKey && viennaDistrictMap[districtKey]) {
    // Example: "1060 Wien, Österreich"
    mapSearchQuery = viennaDistrictMap[districtKey];
    mapZoom = 13;
  } else {
    // Fallback to the full district name if mapping fails
    mapSearchQuery = `${propertyData.locationVienna}, Wien, Österreich`;
    mapZoom = 13;
  }
} else if (propertyData.locationSurrounding) {
  // FALLBACK 4: Surrounding Area (Original robust fallback)
  // Example: "2453 Sommerein, Österreich"
  mapSearchQuery = `${propertyData.locationSurrounding}, Österreich`;
  mapZoom = 12;
} else {
  // DEFAULT FALLBACK: Least specific
  mapSearchQuery = "Wien, Österreich";
  mapZoom = 11;
}

// Encode the finalized search query. This query controls both centering and the top-left label.
const encodedMapQuery = encodeURIComponent(mapSearchQuery);

// Construct the embed URL
const googleMapsEmbedUrl = `https://maps.google.com/maps?q=${encodedMapQuery}&z=${mapZoom}&output=embed`;

// ----------------------------------------------------
// ✨ MAP LOGIC END
// ----------------------------------------------------

// 5. Serialize the data to pass it as a JSON string to the client-side component
const propertyDataJson = JSON.stringify(propertyData);

// ----------------------------------------------------
// ✨ SEO & METADATA SETUP
// ----------------------------------------------------

const title = propertyData.title || "Immobilien Detail";
const location = propertyData.locationVienna
  ? `Wien, ${propertyData.locationVienna}`
  : propertyData.locationSurrounding;

// Create a concise description for the meta tag
const rawDescription = propertyData.propertyDescription
  ? propertyData.propertyDescription.substring(0, 100)
  : "Besichtigungstermine auf Anfrage"; // Provide a helpful, non-crashing default text

const pageDescription = `Miete: ${title} in ${location}. ${rawDescription}...`;
// Open Graph Image URL (Use the main image URL you fixed earlier)
const ogImageUrl = propertyData.mainImage.url;

// Set the page title for the Layout component
const pageTitle = title;

// ----------------------------------------------------
// ✨ JSON-LD GENERATION (CORRECTLY MOVED TO FRONTMATTER)
// ----------------------------------------------------

// --- JSON-LD Helper Function ---
// This function determines the correct postal code based on the data structure
const getPostalCode = (data) => {
  if (data.locationVienna) {
    // Extracts the district number (e.g., '1', '2', '23')
    const districtMatch = data.locationVienna.match(/^\d+/);
    const districtNumber = districtMatch ? districtMatch[0] : null;

    // Vienna postal code structure: 1XX0 (e.g., 1010, 1020, 1100)
    if (districtNumber) {
      // Special case for 1st-9th district (1010-1090)
      if (districtNumber.length === 1) return `10${districtNumber}0`;
      // General case for 10th-23rd district
      if (districtNumber.length === 2) return `1${districtNumber}0`;
    }
  }
  // Fallback for surrounding areas
  return data.postalCodeSurrounding
    ? data.postalCodeSurrounding.toString()
    : null;
};

// Determine the price and transactional type
const price = propertyData.purchasePrice || propertyData.rentalPrice;

// Determine the address locality (City/District)
const addressLocality = propertyData.locationVienna
  ? propertyData.locationVienna.split(".")[1].trim() // e.g., "Leopoldstadt"
  : propertyData.locationSurrounding;

// --- JSON-LD Object Construction ---
const realEstateSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "RealEstateListing",

  /* ---------------------- BASISDATEN ---------------------- */
  name: propertyData.name,

  // Use propertyDescription, ensuring it's not null
  description: propertyData.propertyDescription
    ? propertyData.propertyDescription.substring(0, 300)
    : propertyData.name,

  // URL dieser spezifischen Anzeige
  url: `${Astro.site}${propertyData.slug.current}`,

  // Hauptbild (Titelfoto)
  image: propertyData.mainImage.url,

  // Datum der Veröffentlichung (Use Sanity ID creation date if no specific date is available)
  datePosted: propertyData.id ? propertyData.id.substring(0, 8) : null,

  /* ---------------------- PREIS & ANGEBOT (OFFERS) ---------------------- */
  offers: {
    "@type": "Offer",
    priceCurrency: "EUR",
    price: price,

    // Verfügbarkeit prüfen
    availability: propertyData.available
      ? "https://schema.org/InStock"
      : "https://schema.org/SoldOut",

    itemCondition: propertyData.isFullyFurnished
      ? "https://schema.org/UsedCondition"
      : "https://schema.org/NewCondition",
  },

  /* ---------------------- IMMOBILIEN-DETAILS (PROPERTY) ---------------------- */

  numberOfRooms: propertyData.rooms,
  numberOfBathroomsTotal: propertyData.bathrooms,

  // propertyType mappen (Wohnung/Haus etc.)
  homeType: propertyData.propertyType,

  // Details zur Fläche
  floorSize: {
    "@type": "QuantitativeValue",
    value: propertyData.livingArea || propertyData.useableArea,
    unitText: "SQM",
  },

  // Baujahr
  yearBuilt: propertyData.yearBuilt,
  floorLevel: propertyData.floor,

  /* ---------------------- ADRESSE (ADDRESS) ---------------------- */
  address: {
    "@type": "PostalAddress",

    streetAddress: propertyData.address,
    addressLocality: addressLocality,
    addressRegion: propertyData.locationVienna
      ? "Wien"
      : propertyData.locationSurrounding,
    postalCode: getPostalCode(propertyData),
    addressCountry: "AT",
  },

  /* ---------------------- AGENT INFO ---------------------- */
  // Including the agent as a primary contact point for the listing
  ...(propertyData.agent && {
    broker: {
      "@type": "RealEstateAgent",
      name: propertyData.agent.name,
      telephone: propertyData.agent.phone,
      email: propertyData.agent.email,
      address: {
        "@type": "PostalAddress",
        streetAddress: "Auhofstrasse 78C/1",
        addressLocality: "Wien",
        postalCode: "1130", // Replace with actual office postal code
        addressCountry: "AT",
      },
    },
  }),
});

// ----------------------------------------------------
// ✨ END JSON-LD GENERATION
// ----------------------------------------------------
---

<MainLayout
  title={pageTitle}
  description={pageDescription}
  ogImage={ogImageUrl}
  ogTitle={`Wohnung mieten: ${title}`}
  schema={realEstateSchema}
>
  <PropertyListingDetails
    propertyDataJson={propertyDataJson}
    googleMapsEmbedUrl={googleMapsEmbedUrl}
  />
</MainLayout>
